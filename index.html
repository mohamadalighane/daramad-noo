<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="metaTitle">درآمد نو | مقالات کسب درآمد</title>
  <meta name="description" id="metaDesc" content="مقالات تخصصی کسب درآمد آنلاین، فریلنسری، سرمایه‌گذاری و کارآفرینی">
  <meta name="robots" content="index, follow">
  <link rel="canonical" id="metaCanonical" href="https://mohamadalighane.github.io/daramad-noo/">
  <meta property="og:title" id="ogTitle" content="درآمد نو">
  <meta property="og:description" id="ogDesc" content="مقالات تخصصی کسب درآمد آنلاین">
  <meta property="og:image" id="ogImage" content="">
  <meta property="og:type" id="ogType" content="website">
  <script type="application/ld+json" id="schemaOrg">{"@context":"https://schema.org","@type":"WebSite","name":"درآمد نو","url":"https://mohamadalighane.github.io/daramad-noo/","inLanguage":"fa"}</script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>window.NAJVA={};var s=document.createElement("script");s.src="https://van.najva.com/static/js/main-script.js";s.defer=!0;s.id="najva-mini-script";s.setAttribute("data-najva-id","e35f8d3d-3bb6-4151-bca2-a7b75a5c3f3b");document.head.appendChild(s);</script>

   <script>
            !function(e,t,n){e.yektanetAnalyticsObject=n,e[n]=e[n]||function(){e[n].q.push(arguments)},e[n].q=e[n].q||[];var a=t.getElementsByTagName("head")[0],r=new Date,c="https://cdn.yektanet.com/superscript/YjPyWkx4/native-proai-eta.vercel.app-45688/yn_pub.js?v="+r.getFullYear().toString()+"0"+r.getMonth()+"0"+r.getDate()+"0"+r.getHours(),s=t.createElement("link");s.rel="preload",s.as="script",s.href=c,a.appendChild(s);var l=t.createElement("script");l.async=!0,l.src=c,a.appendChild(l)}(window,document,"yektanet");
        </script>



  <style>
    :root {
      --bg: #0a0f0d;
      --bg2: #0f1712;
      --surface: #131a15;
      --surface2: #1a2520;
      --surface3: #1f2d25;
      --border: rgba(255,255,255,0.07);
      --border2: rgba(255,255,255,0.12);
      --accent: #22c55e;
      --accent2: #16a34a;
      --accent3: #4ade80;
      --accent-glow: rgba(34,197,94,0.15);
      --accent-glow2: rgba(34,197,94,0.08);
      --text: #f0fdf4;
      --text2: #a3b5a8;
      --text3: #5a7060;
      --gold: #f59e0b;
      --red: #ef4444;
      --blue: #3b82f6;
      --shadow-sm: 0 1px 3px rgba(0,0,0,.4);
      --shadow: 0 4px 24px rgba(0,0,0,.5);
      --shadow-lg: 0 16px 64px rgba(0,0,0,.7);
      --shadow-glow: 0 0 40px rgba(34,197,94,.12);
      --r: 18px;
      --r-sm: 12px;
      --r-xs: 8px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{
      font-family:'Vazirmatn',sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      font-size:15px;
      line-height:1.7;
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
    }

    /* ── BACKGROUND TEXTURE ── */
    body::before {
      content:'';
      position:fixed;
      inset:0;
      background:
        radial-gradient(ellipse 80% 50% at 20% -10%, rgba(34,197,94,0.06) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 80% 100%, rgba(34,197,94,0.04) 0%, transparent 50%);
      pointer-events:none;
      z-index:0;
    }

    /* ── SCROLLBAR ── */
    ::-webkit-scrollbar{width:5px}
    ::-webkit-scrollbar-track{background:var(--bg)}
    ::-webkit-scrollbar-thumb{background:linear-gradient(to bottom, var(--accent), var(--accent2));border-radius:3px}

    /* ══════════════════════════════════
       HEADER
    ══════════════════════════════════ */
    header {
      background: rgba(10,15,13,0.85);
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 200;
      transition: all .3s;
    }
    header.scrolled {
      background: rgba(10,15,13,0.95);
      border-bottom-color: var(--border2);
      box-shadow: 0 4px 32px rgba(0,0,0,.6);
    }
    .hdr {
      max-width: 1320px;
      margin: 0 auto;
      padding: 0 28px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      text-decoration: none;
    }
    .logo-mark {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 16px rgba(34,197,94,.35), inset 0 1px 0 rgba(255,255,255,.15);
      flex-shrink: 0;
      transition: all .3s cubic-bezier(.16,1,.3,1);
      position: relative;
      overflow: hidden;
    }
    .logo-mark::after {
      content:'';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,.15) 0%, transparent 60%);
      border-radius: inherit;
    }
    .logo:hover .logo-mark {
      transform: rotate(-8deg) scale(1.08);
      box-shadow: 0 8px 28px rgba(34,197,94,.5);
    }
    .logo-text { display: flex; flex-direction: column; gap: 2px; }
    .logo-name {
      font-weight: 900;
      font-size: 18px;
      color: var(--text);
      line-height: 1;
      letter-spacing: -.4px;
    }
    .logo-sub { font-size: 11px; color: var(--text3); line-height: 1; }

    .hdr-nav { display: flex; align-items: center; gap: 6px; }
    .nav-link {
      padding: 9px 18px;
      border-radius: 50px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text2);
      cursor: pointer;
      transition: all .2s;
      border: 1px solid transparent;
      background: none;
      font-family: 'Vazirmatn', sans-serif;
      letter-spacing: .2px;
    }
    .nav-link:hover {
      background: var(--surface2);
      border-color: var(--border2);
      color: var(--text);
    }
    .nav-link.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 2px 12px rgba(34,197,94,.3);
    }
    .nav-link.primary:hover {
      box-shadow: 0 4px 20px rgba(34,197,94,.45);
      transform: translateY(-1px);
    }

    /* ══════════════════════════════════
       PAGES
    ══════════════════════════════════ */
    .page { display: none; }
    .page.active { display: block; animation: fadeUp .4s cubic-bezier(.16,1,.3,1); }
    @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:none} }

    /* ══════════════════════════════════
       HERO SLIDER
    ══════════════════════════════════ */
    .slider-section {
      position: relative;
      overflow: hidden;
      background: var(--bg);
      min-height: 560px;
    }
    .slides {
      display: flex;
      transition: transform .7s cubic-bezier(.65,0,.35,1);
      height: 100%;
    }
    .slide {
      min-width: 100%;
      position: relative;
      min-height: 560px;
      display: flex;
      align-items: center;
      overflow: hidden;
    }
    .slide-bg {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      transition: transform 7s ease;
    }
    .slide-bg::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(
        125deg,
        rgba(10,15,13,0.92) 0%,
        rgba(10,15,13,0.6) 50%,
        rgba(10,15,13,0.3) 100%
      );
    }
    .slide.active .slide-bg { transform: scale(1.06); }
    .slide-content {
      position: relative;
      z-index: 2;
      max-width: 760px;
      padding: 80px 72px;
      color: #fff;
    }
    .slide-badge {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      background: rgba(34,197,94,.15);
      border: 1px solid rgba(34,197,94,.3);
      backdrop-filter: blur(10px);
      padding: 6px 16px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--accent3);
      letter-spacing: .3px;
    }
    .slide-title {
      font-size: clamp(28px, 4.5vw, 52px);
      font-weight: 900;
      line-height: 1.2;
      margin-bottom: 20px;
      letter-spacing: -.6px;
      text-shadow: 0 2px 20px rgba(0,0,0,.5);
    }
    .slide-desc {
      font-size: 16px;
      opacity: .8;
      max-width: 500px;
      margin-bottom: 36px;
      line-height: 1.75;
    }
    .slide-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      padding: 15px 32px;
      border-radius: 50px;
      font-family: 'Vazirmatn', sans-serif;
      font-size: 14px;
      font-weight: 800;
      cursor: pointer;
      border: none;
      transition: all .3s cubic-bezier(.16,1,.3,1);
      box-shadow: 0 4px 24px rgba(34,197,94,.4), inset 0 1px 0 rgba(255,255,255,.2);
      letter-spacing: .2px;
    }
    .slide-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 40px rgba(34,197,94,.55);
    }
    .slider-controls {
      position: absolute;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,.3);
      cursor: pointer;
      transition: all .35s;
      border: none;
    }
    .dot.active { width: 28px; border-radius: 4px; background: var(--accent); }
    .slider-arrows {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 10;
      pointer-events: none;
    }
    .slider-arrow {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.9);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .25s;
      pointer-events: all;
    }
    .slider-arrow:hover {
      background: rgba(34,197,94,.2);
      border-color: rgba(34,197,94,.4);
      color: var(--accent3);
    }

    /* ══════════════════════════════════
       MAIN
    ══════════════════════════════════ */
    .main {
      max-width: 1320px;
      margin: 0 auto;
      padding: 64px 28px;
      position: relative;
      z-index: 1;
    }

    /* Section Header */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .section-title {
      font-size: 24px;
      font-weight: 900;
      color: var(--text);
      position: relative;
      padding-right: 18px;
      letter-spacing: -.3px;
    }
    .section-title::before {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 24px;
      background: linear-gradient(to bottom, var(--accent), var(--accent2));
      border-radius: 2px;
      box-shadow: 0 0 12px var(--accent);
    }
    .art-count {
      font-size: 12px;
      color: var(--text3);
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 5px 14px;
      border-radius: 50px;
      font-weight: 600;
    }

    /* ── CAT FILTER ── */
    .cat-filter {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 36px;
    }
    .cat-chip {
      padding: 8px 20px;
      border-radius: 50px;
      border: 1px solid var(--border2);
      background: var(--surface);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: var(--text2);
      cursor: pointer;
      transition: all .25s;
      letter-spacing: .2px;
    }
    .cat-chip:hover {
      border-color: var(--accent);
      color: var(--accent3);
      background: var(--accent-glow2);
    }
    .cat-chip.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 2px 14px rgba(34,197,94,.3);
    }

    /* ══════════════════════════════════
       CARDS GRID
    ══════════════════════════════════ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 24px;
    }
    .card {
      background: var(--surface);
      border-radius: var(--r);
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all .4s cubic-bezier(.16,1,.3,1);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--r);
      background: linear-gradient(135deg, rgba(34,197,94,.04) 0%, transparent 50%);
      opacity: 0;
      transition: opacity .3s;
      pointer-events: none;
      z-index: 1;
    }
    .card:hover {
      transform: translateY(-8px);
      border-color: rgba(34,197,94,.25);
      box-shadow: 0 20px 60px rgba(0,0,0,.7), 0 0 30px rgba(34,197,94,.08);
    }
    .card:hover::before { opacity: 1; }
    .card-img-wrap {
      position: relative;
      overflow: hidden;
      height: 220px;
      background: var(--surface2);
    }
    .card-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform .6s cubic-bezier(.16,1,.3,1);
    }
    .card:hover .card-img { transform: scale(1.08); }
    .card-ph {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 56px;
      background: linear-gradient(135deg, var(--surface2), var(--surface3));
    }
    .card-cat-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(10,15,13,.75);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(34,197,94,.3);
      padding: 5px 14px;
      border-radius: 50px;
      font-size: 11px;
      font-weight: 800;
      color: var(--accent3);
      letter-spacing: .3px;
    }
    .card-body {
      padding: 24px;
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 2;
    }
    .card-date {
      font-size: 11px;
      color: var(--text3);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 600;
    }
    .card-title {
      font-size: 17px;
      font-weight: 800;
      margin-bottom: 12px;
      line-height: 1.5;
      color: var(--text);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      letter-spacing: -.2px;
    }
    .card-desc {
      color: var(--text2);
      font-size: 13px;
      line-height: 1.75;
      flex: 1;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .card-foot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .read-more {
      color: var(--accent);
      font-weight: 700;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: gap .2s;
    }
    .read-more::after { content: '←'; }
    .card:hover .read-more { gap: 8px; color: var(--accent3); }

    /* ── SEARCH ── */
    .search-bar {
      max-width: 580px;
      margin: 0 auto 36px;
      position: relative;
    }
    .search-input {
      width: 100%;
      padding: 16px 52px 16px 24px;
      border-radius: 50px;
      border: 1.5px solid var(--border2);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 14px;
      color: var(--text);
      background: var(--surface);
      outline: none;
      transition: all .25s;
      box-shadow: var(--shadow-sm);
    }
    .search-input::placeholder { color: var(--text3); }
    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(34,197,94,.1), var(--shadow);
      background: var(--surface2);
    }
    .search-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text3);
      font-size: 17px;
      pointer-events: none;
    }

    /* ── PAGINATION ── */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-top: 56px;
      flex-wrap: wrap;
    }
    .pg-btn {
      min-width: 42px;
      height: 42px;
      padding: 0 8px;
      border-radius: var(--r-sm);
      border: 1px solid var(--border2);
      background: var(--surface);
      color: var(--text2);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pg-btn:hover:not(:disabled) {
      background: var(--surface2);
      border-color: var(--accent);
      color: var(--accent3);
    }
    .pg-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 2px 12px rgba(34,197,94,.3);
    }
    .pg-btn:disabled { opacity: .3; cursor: not-allowed; }
    .pg-sep { color: var(--text3); font-size: 13px; padding: 0 4px; }

    /* ── EMPTY ── */
    .empty { text-align: center; padding: 80px 20px; grid-column: 1/-1; }
    .empty-icon { font-size: 60px; margin-bottom: 20px; filter: grayscale(.3); }
    .empty h3 { font-size: 19px; font-weight: 800; color: var(--text2); margin-bottom: 8px; }
    .empty p { color: var(--text3); font-size: 14px; }

    /* ══════════════════════════════════
       DETAIL PAGE
    ══════════════════════════════════ */
    .detail-outer { background: var(--bg); }
    .detail-wrap { max-width: 860px; margin: 0 auto; padding: 56px 28px; }
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 9px;
      color: var(--text2);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 40px;
      padding: 10px 20px;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 50px;
      transition: all .25s;
    }
    .back-btn:hover {
      background: var(--surface2);
      border-color: var(--accent);
      color: var(--accent3);
    }
    .detail-img {
      width: 100%;
      max-height: 480px;
      object-fit: cover;
      border-radius: var(--r);
      margin-bottom: 40px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }
    .detail-title {
      font-size: clamp(26px, 4vw, 40px);
      font-weight: 900;
      margin-bottom: 20px;
      line-height: 1.3;
      letter-spacing: -.5px;
      color: var(--text);
    }
    .detail-meta {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 28px;
    }
    .detail-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text3);
      font-weight: 600;
    }
    .detail-badge {
      background: rgba(34,197,94,.12);
      border: 1px solid rgba(34,197,94,.25);
      color: var(--accent3);
      padding: 5px 14px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .3px;
    }
    .detail-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 36px;
      flex-wrap: wrap;
      padding-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }
    .video-frame { border-radius: var(--r); overflow: hidden; margin-bottom: 36px; box-shadow: var(--shadow); border: 1px solid var(--border); }
    .video-frame iframe { width: 100%; height: 400px; border: none; display: block; }
    .video-link-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 18px 24px;
      background: var(--surface);
      border: 1px solid var(--border2);
      color: var(--text);
      text-decoration: none;
      border-radius: var(--r);
      margin-bottom: 36px;
      font-size: 14px;
      font-weight: 700;
      transition: all .25s;
    }
    .video-link-btn:hover { border-color: var(--accent); background: var(--surface2); color: var(--accent3); }

    /* ── RICH CONTENT ── */
    .rich-content {
      color: var(--text2);
      line-height: 1.95;
      font-size: 16px;
    }
    .rich-content h1 { font-size: 30px; font-weight: 900; color: var(--text); margin: 40px 0 16px; letter-spacing: -.4px; }
    .rich-content h2 {
      font-size: 23px;
      font-weight: 800;
      color: var(--text);
      margin: 36px 0 14px;
      padding-right: 18px;
      border-right: 4px solid var(--accent);
      border-radius: 0 2px 2px 0;
    }
    .rich-content h3 { font-size: 19px; font-weight: 700; color: var(--text); margin: 28px 0 12px; }
    .rich-content p { margin-bottom: 18px; }
    .rich-content strong { font-weight: 800; color: var(--text); }
    .rich-content em { font-style: italic; color: var(--text); }
    .rich-content u { text-decoration: underline; text-decoration-color: var(--accent); }
    .rich-content ul, .rich-content ol { padding-right: 28px; margin-bottom: 18px; }
    .rich-content li { margin-bottom: 10px; }
    .rich-content a { color: var(--accent3); text-decoration: none; border-bottom: 1px solid rgba(74,222,128,.3); transition: border-color .2s; }
    .rich-content a:hover { border-color: var(--accent3); }
    .rich-content blockquote {
      border-right: 4px solid var(--gold);
      padding: 18px 22px;
      margin: 28px 0;
      background: rgba(245,158,11,.06);
      border-radius: 0 var(--r-sm) var(--r-sm) 0;
      font-style: italic;
      color: #d6b06a;
      border: 1px solid rgba(245,158,11,.15);
      border-right: 4px solid var(--gold);
    }
    .rich-content .code-block { position: relative; margin: 24px 0; }
    .rich-content pre {
      background: #060b09;
      color: #a3e6c0;
      padding: 28px;
      border-radius: var(--r-sm);
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.7;
      direction: ltr;
      text-align: left;
      border: 1px solid rgba(34,197,94,.15);
    }
    .rich-content .copy-btn {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(34,197,94,.1);
      color: var(--accent);
      border: 1px solid rgba(34,197,94,.25);
      border-radius: var(--r-xs);
      padding: 5px 12px;
      font-size: 11px;
      cursor: pointer;
      font-family: 'Vazirmatn', sans-serif;
      transition: all .2s;
      font-weight: 700;
    }
    .rich-content .copy-btn:hover { background: rgba(34,197,94,.2); color: var(--accent3); }
    .rich-content code {
      background: rgba(34,197,94,.08);
      color: var(--accent3);
      padding: 2px 8px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      border: 1px solid rgba(34,197,94,.15);
    }
    .rich-content hr {
      border: none;
      border-top: 1px solid var(--border2);
      margin: 36px 0;
    }
    .rich-content .info-box {
      background: rgba(59,130,246,.07);
      border: 1px solid rgba(59,130,246,.2);
      border-right: 4px solid var(--blue);
      padding: 14px 18px;
      border-radius: 0 var(--r-xs) var(--r-xs) 0;
      margin: 20px 0;
      color: #93c5fd;
      line-height: 1.7;
    }
    .rich-content .warn-box {
      background: rgba(245,158,11,.07);
      border: 1px solid rgba(245,158,11,.2);
      border-right: 4px solid var(--gold);
      padding: 14px 18px;
      border-radius: 0 var(--r-xs) var(--r-xs) 0;
      margin: 20px 0;
      color: #fcd34d;
      line-height: 1.7;
    }
    .rich-content .success-box {
      background: rgba(34,197,94,.07);
      border: 1px solid rgba(34,197,94,.2);
      border-right: 4px solid var(--accent);
      padding: 14px 18px;
      border-radius: 0 var(--r-xs) var(--r-xs) 0;
      margin: 20px 0;
      color: var(--accent3);
      line-height: 1.7;
    }
    .rich-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 14px;
    }
    .rich-content th {
      background: var(--surface2);
      color: var(--text);
      font-weight: 800;
      padding: 12px 16px;
      text-align: right;
      border: 1px solid var(--border2);
    }
    .rich-content td {
      padding: 11px 16px;
      border: 1px solid var(--border);
      color: var(--text2);
    }
    .rich-content tr:nth-child(even) td { background: rgba(255,255,255,.02); }
    .rich-content .img-with-caption {
      text-align: center;
      margin: 20px 0;
    }
    .rich-content .img-with-caption img {
      max-width: 100%;
      border-radius: var(--r-sm);
      border: 1px solid var(--border);
    }
    .rich-content .img-with-caption figcaption {
      font-size: 12px;
      color: var(--text3);
      margin-top: 8px;
      font-style: italic;
    }
    .rich-content .article-toc {
      background: rgba(34,197,94,.05);
      border: 1px solid rgba(34,197,94,.2);
      border-radius: 12px;
      padding: 0;
      margin: 24px 0;
      overflow: hidden;
    }
    .toc-toggle-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      cursor: pointer;
      user-select: none;
      transition: background .2s;
    }
    .toc-toggle-header:hover { background: rgba(34,197,94,.08); }
    .toc-toggle-title {
      font-size: 14px;
      font-weight: 800;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toc-toggle-arrow {
      color: var(--accent3);
      font-size: 13px;
      transition: transform .3s cubic-bezier(.16,1,.3,1);
      font-style: normal;
    }
    .toc-toggle-arrow.open { transform: rotate(180deg); }
    .toc-body {
      overflow: hidden;
      max-height: 0;
      transition: max-height .4s cubic-bezier(.16,1,.3,1);
    }
    .toc-body.open { max-height: 600px; }
    .toc-body ol {
      list-style: none;
      padding: 4px 20px 16px;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      border-top: 1px solid rgba(34,197,94,.15);
    }
    .toc-body ol li a {
      color: var(--text2) !important;
      text-decoration: none !important;
      border-bottom: none !important;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 8px;
      border-radius: 6px;
      transition: all .2s;
    }
    .toc-body ol li a:hover {
      background: rgba(34,197,94,.08);
      color: var(--accent3) !important;
    }
    .toc-body ol li.h3 a { padding-right: 20px; font-size: 12px; color: var(--text3) !important; }

    /* ══════════════════════════════════
       READ PROGRESS BAR
    ══════════════════════════════════ */
    #readProgress {
      position: fixed;
      top: 0;
      right: 0;
      height: 3px;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent3));
      z-index: 9999;
      transition: width .1s;
      box-shadow: 0 0 10px rgba(34,197,94,.5);
    }

    /* ══════════════════════════════════
       BACK TO TOP
    ══════════════════════════════════ */
    #backToTop {
      position: fixed;
      bottom: 32px;
      left: 32px;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      border: none;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(34,197,94,.4);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: translateY(20px);
      transition: all .3s cubic-bezier(.16,1,.3,1);
      pointer-events: none;
    }
    #backToTop.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
    #backToTop:hover { transform: translateY(-3px); box-shadow: 0 8px 28px rgba(34,197,94,.55); }

    /* ══════════════════════════════════
       THEME TOGGLE
    ══════════════════════════════════ */
    #themeToggle {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: var(--surface2);
      border: 1px solid var(--border2);
      color: var(--text2);
      font-size: 17px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .25s;
    }
    #themeToggle:hover { background: var(--surface3); color: var(--text); }

    /* Light theme overrides */
    body.light-theme {
      --bg: #f8faf9;
      --bg2: #f0f5f2;
      --surface: #ffffff;
      --surface2: #f3f7f4;
      --surface3: #e8f0ea;
      --border: rgba(0,0,0,0.08);
      --border2: rgba(0,0,0,0.14);
      --text: #0f1712;
      --text2: #3a5040;
      --text3: #7a9882;
      --shadow-sm: 0 1px 3px rgba(0,0,0,.1);
      --shadow: 0 4px 24px rgba(0,0,0,.1);
      --shadow-lg: 0 16px 64px rgba(0,0,0,.15);
    }
    body.light-theme header { background: rgba(248,250,249,.92); }
    body.light-theme header.scrolled { background: rgba(248,250,249,.97); }
    body.light-theme .editor-body-pro, body.light-theme .preview-inner { color: #0f1712; }

    /* ══════════════════════════════════
       BOOKMARK BUTTON
    ══════════════════════════════════ */
    .bookmark-btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 11px 22px;
      border-radius: var(--r-sm);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid var(--border2);
      background: var(--surface);
      color: var(--text2);
      transition: all .25s;
    }
    .bookmark-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(245,158,11,.07); }
    .bookmark-btn.saved { background: rgba(245,158,11,.12); border-color: var(--gold); color: var(--gold); }

    /* ══════════════════════════════════
       COMMENTS
    ══════════════════════════════════ */
    .comments-section {
      margin-top: 56px;
      padding-top: 40px;
      border-top: 1px solid var(--border);
    }
    .comments-title {
      font-size: 20px;
      font-weight: 900;
      margin-bottom: 28px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .comment-count {
      background: rgba(34,197,94,.12);
      border: 1px solid rgba(34,197,94,.25);
      color: var(--accent3);
      padding: 3px 12px;
      border-radius: 50px;
      font-size: 13px;
      font-weight: 800;
    }
    .comment-form {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 22px;
      margin-bottom: 32px;
    }
    .comment-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .comment-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid var(--border2);
      border-radius: var(--r-xs);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 13px;
      color: var(--text);
      background: var(--surface3);
      outline: none;
      resize: vertical;
      min-height: 100px;
      transition: border-color .2s;
      margin-bottom: 12px;
    }
    .comment-textarea:focus { border-color: var(--accent); }
    .comment-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 18px 20px;
      margin-bottom: 12px;
      transition: border-color .2s;
    }
    .comment-item:hover { border-color: var(--border2); }
    .comment-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .comment-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 900;
      color: #fff;
      flex-shrink: 0;
    }
    .comment-author { font-weight: 800; font-size: 14px; color: var(--text); }
    .comment-date { font-size: 11px; color: var(--text3); margin-top: 2px; }
    .comment-body { font-size: 14px; color: var(--text2); line-height: 1.75; }

    /* ══════════════════════════════════
       RELATED ARTICLES
    ══════════════════════════════════ */
    .related-section {
      margin-top: 56px;
      padding-top: 40px;
      border-top: 1px solid var(--border);
    }
    .related-title {
      font-size: 20px;
      font-weight: 900;
      margin-bottom: 24px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .related-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
    }
    .related-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      overflow: hidden;
      cursor: pointer;
      transition: all .3s cubic-bezier(.16,1,.3,1);
    }
    .related-card:hover {
      transform: translateY(-4px);
      border-color: rgba(34,197,94,.2);
      box-shadow: var(--shadow);
    }
    .related-thumb {
      height: 130px;
      background: var(--surface2);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
    }
    .related-thumb img { width:100%;height:100%;object-fit:cover;transition:transform .4s; }
    .related-card:hover .related-thumb img { transform: scale(1.06); }
    .related-body { padding: 14px; }
    .related-card-title {
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .related-card-date { font-size: 11px; color: var(--text3); margin-top: 6px; font-weight: 600; }

    /* ══════════════════════════════════
       BUTTONS
    ══════════════════════════════════ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 11px 22px;
      border-radius: var(--r-sm);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: all .25s;
      text-decoration: none;
      letter-spacing: .2px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      box-shadow: 0 2px 12px rgba(34,197,94,.25);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 24px rgba(34,197,94,.4);
      transform: translateY(-1px);
    }
    .btn-ghost {
      background: var(--surface);
      color: var(--text2);
      border: 1px solid var(--border2);
    }
    .btn-ghost:hover { background: var(--surface2); color: var(--text); }
    .btn-danger { background: var(--red); color: #fff; }
    .btn-danger:hover { opacity: .85; }
    .btn-warn { background: var(--gold); color: #fff; }
    .btn-warn:hover { opacity: .85; }
    .btn-dark { background: var(--surface2); color: var(--text); border: 1px solid var(--border2); }
    .btn-dark:hover { background: var(--surface3); }
    .btn:disabled { opacity: .4; cursor: not-allowed; transform: none !important; }

    /* ══════════════════════════════════
       LOGIN
    ══════════════════════════════════ */
    .login-page {
      min-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px;
    }
    .login-card {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      padding: 52px 44px;
      width: 100%;
      max-width: 420px;
      box-shadow: var(--shadow-lg);
    }
    .login-icon { text-align: center; font-size: 52px; margin-bottom: 28px; }
    .login-title {
      font-size: 26px;
      font-weight: 900;
      text-align: center;
      margin-bottom: 8px;
      color: var(--text);
    }
    .login-sub { color: var(--text3); font-size: 13px; text-align: center; margin-bottom: 36px; }

    /* ══════════════════════════════════
       FORM
    ══════════════════════════════════ */
    .f-group { margin-bottom: 20px; }
    .f-label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: var(--text2); }
    .f-input, .f-textarea, .f-select {
      width: 100%;
      padding: 13px 18px;
      border: 1.5px solid var(--border2);
      border-radius: var(--r-xs);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 14px;
      color: var(--text);
      background: var(--surface2);
      outline: none;
      transition: all .2s;
    }
    .f-input::placeholder, .f-textarea::placeholder { color: var(--text3); }
    .f-input:focus, .f-textarea:focus, .f-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34,197,94,.1);
      background: var(--surface3);
    }
    .f-select option { background: var(--surface2); }
    .f-textarea { min-height: 160px; resize: vertical; }
    .f-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .f-full { grid-column: 1/-1; }
    .alert {
      padding: 13px 18px;
      border-radius: var(--r-xs);
      font-size: 13px;
      margin-bottom: 18px;
      display: none;
      line-height: 1.6;
      font-weight: 600;
    }
    .alert-err { background: rgba(239,68,68,.08); border: 1px solid rgba(239,68,68,.25); color: #fca5a5; }
    .alert-ok { background: rgba(34,197,94,.08); border: 1px solid rgba(34,197,94,.25); color: var(--accent3); }

    /* ── UPLOAD ── */
    .upload-area {
      border: 1.5px dashed var(--border2);
      border-radius: var(--r-sm);
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all .25s;
      background: var(--surface2);
      position: relative;
      overflow: hidden;
    }
    .upload-area:hover { border-color: var(--accent); background: rgba(34,197,94,.05); }
    .upload-area input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .upload-preview { width: 100%; max-height: 180px; object-fit: cover; border-radius: var(--r-xs); margin-top: 14px; display: none; }
    .upload-bar-wrap { height: 3px; background: var(--border); border-radius: 2px; margin-top: 12px; display: none; }
    .upload-bar { height: 100%; background: var(--accent); border-radius: 2px; transition: width .3s; width: 0%; }

    /* ── CAT MANAGER ── */
    .cat-manager { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--r-xs); padding: 16px; margin-top: 10px; }
    .cat-manager-title { font-size: 11px; font-weight: 700; color: var(--text3); margin-bottom: 12px; letter-spacing: .8px; text-transform: uppercase; }
    .cat-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .cat-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 20px;
      background: rgba(34,197,94,.1);
      border: 1px solid rgba(34,197,94,.2);
      color: var(--accent3);
      font-size: 12px;
      font-weight: 700;
    }
    .cat-tag .del-cat { cursor: pointer; font-size: 15px; line-height: 1; color: var(--red); font-weight: 800; margin-right: 2px; }
    .cat-add-row { display: flex; gap: 8px; }
    .cat-add-input {
      flex: 1;
      padding: 9px 14px;
      border: 1.5px solid var(--border2);
      border-radius: var(--r-xs);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 13px;
      outline: none;
      background: var(--surface3);
      color: var(--text);
      transition: border-color .2s;
    }
    .cat-add-input:focus { border-color: var(--accent); }
    .cat-add-btn {
      padding: 9px 18px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      border: none;
      border-radius: var(--r-xs);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
    }
    .cat-add-btn:hover { opacity: .9; }

    /* ── EDITOR ── */
    .editor-wrap {
      border: 1.5px solid var(--border2);
      border-radius: var(--r-sm);
      overflow: hidden;
      background: var(--surface);
      transition: border-color .2s;
    }
    .editor-wrap:focus-within { border-color: var(--accent); }
    .editor-toolbar {
      display: flex;
      gap: 2px;
      padding: 10px 12px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      align-items: center;
    }
    .tb-btn {
      min-width: 34px;
      height: 34px;
      border: none;
      border-radius: var(--r-xs);
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text2);
      transition: all .2s;
      font-family: serif;
      padding: 0 7px;
    }
    .tb-btn:hover { background: var(--surface3); color: var(--text); }
    .tb-btn.active { background: var(--accent); color: #fff; }
    .tb-sep { width: 1px; background: var(--border2); margin: 0 5px; align-self: stretch; height: 24px; }
    .tb-select {
      padding: 5px 10px;
      border: 1px solid var(--border2);
      border-radius: var(--r-xs);
      font-family: 'Vazirmatn', sans-serif;
      font-size: 12px;
      background: var(--surface3);
      color: var(--text2);
      cursor: pointer;
      outline: none;
    }
    .editor-body {
      min-height: 280px;
      padding: 22px;
      outline: none;
      font-family: 'Vazirmatn', sans-serif;
      font-size: 14px;
      line-height: 1.9;
      color: var(--text);
      direction: rtl;
    }
    .editor-body:empty::before { content: attr(data-placeholder); color: var(--text3); }
    .editor-body h1 { font-size: 22px; font-weight: 900; margin: 16px 0 8px; color: var(--text); }
    .editor-body h2 { font-size: 18px; font-weight: 800; margin: 14px 0 6px; padding-right: 12px; border-right: 3px solid var(--accent); color: var(--text); }
    .editor-body h3 { font-size: 15px; font-weight: 700; margin: 12px 0 4px; color: var(--text); }
    .editor-body blockquote { border-right: 4px solid var(--gold); padding: 10px 14px; background: rgba(245,158,11,.07); margin: 12px 0; border-radius: 0 var(--r-xs) var(--r-xs) 0; color: #d6b06a; }
    .editor-body pre { background: #060b09; color: #a3e6c0; padding: 16px; border-radius: var(--r-xs); font-family: monospace; font-size: 13px; direction: ltr; text-align: left; margin: 12px 0; }
    .editor-body code { background: rgba(34,197,94,.08); color: var(--accent3); padding: 1px 6px; border-radius: 4px; font-family: monospace; }
    .editor-body ul, .editor-body ol { padding-right: 24px; margin: 8px 0; }
    .editor-body a { color: var(--accent3); text-decoration: underline; }
    .editor-footer { padding: 8px 16px; background: var(--surface2); border-top: 1px solid var(--border); font-size: 11px; color: var(--text3); display: flex; justify-content: space-between; align-items: center; }

    /* ══════════════════════════════════
       ADMIN
    ══════════════════════════════════ */
    .admin-layout { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 72px); }
    .admin-sidebar { background: var(--surface); border-left: 1px solid var(--border); padding: 28px 0; display: flex; flex-direction: column; }
    .sidebar-logo { padding: 0 24px 24px; border-bottom: 1px solid var(--border); }
    .sidebar-logo-text { font-size: 16px; font-weight: 900; color: var(--text); }
    .sidebar-logo-sub { font-size: 11px; color: var(--text3); margin-top: 3px; }
    .sidebar-nav { padding: 18px 14px; flex: 1; }
    .sidebar-section { font-size: 10px; font-weight: 700; color: var(--text3); letter-spacing: 1.2px; padding: 0 10px; margin: 20px 0 8px; text-transform: uppercase; }
    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 11px 14px;
      border-radius: var(--r-xs);
      color: var(--text2);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      border: none;
      background: none;
      font-family: 'Vazirmatn', sans-serif;
      width: 100%;
      text-align: right;
    }
    .sidebar-item:hover { background: var(--surface2); color: var(--text); }
    .sidebar-item.active {
      background: rgba(34,197,94,.1);
      color: var(--accent3);
      border: 1px solid rgba(34,197,94,.2);
    }
    .sidebar-item .icon { font-size: 16px; flex-shrink: 0; }
    .sidebar-footer { padding: 18px 14px; border-top: 1px solid var(--border); }
    .admin-main { background: var(--bg2); overflow-y: auto; }
    .admin-topbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 28px;
      height: 62px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .admin-topbar-title { font-size: 17px; font-weight: 900; color: var(--text); }
    .admin-content { padding: 28px; }

    /* ── PANELS ── */
    .panel {
      background: var(--surface);
      border-radius: var(--r);
      border: 1px solid var(--border);
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
    }
    .panel-title {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 22px;
      padding-bottom: 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 9px;
      color: var(--text);
    }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px; margin-bottom: 28px; }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 22px;
      box-shadow: var(--shadow-sm);
      transition: all .25s;
    }
    .stat-card:hover { border-color: rgba(34,197,94,.2); background: var(--surface2); }
    .stat-num { font-size: 36px; font-weight: 900; color: var(--accent); line-height: 1; }
    .stat-label { font-size: 12px; color: var(--text3); margin-top: 6px; font-weight: 700; }

    /* ── SLIDER ADMIN ── */
    .slide-admin-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 18px;
      margin-bottom: 12px;
      display: flex;
      gap: 16px;
      align-items: center;
      transition: border-color .2s;
    }
    .slide-admin-card:hover { border-color: var(--border2); }
    .slide-admin-thumb {
      width: 80px;
      height: 56px;
      border-radius: var(--r-xs);
      overflow: hidden;
      background: var(--surface3);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    .slide-admin-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .slide-admin-info { flex: 1; min-width: 0; }
    .slide-admin-title { font-weight: 700; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 4px; color: var(--text); }
    .slide-admin-actions { display: flex; gap: 6px; flex-shrink: 0; }

    /* ── SETTINGS ── */
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .color-input-wrap { display: flex; gap: 10px; align-items: center; }
    .color-input-wrap input[type=color] { width: 44px; height: 44px; border: 1px solid var(--border2); padding: 2px; cursor: pointer; border-radius: var(--r-xs); background: var(--surface3); }
    .color-input-wrap .f-input { flex: 1; }

    /* ── LIST ITEMS ── */
    .list-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 18px 22px;
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 10px;
      transition: all .25s;
    }
    .list-item:hover { border-color: var(--border2); background: var(--surface2); }
    .list-thumb {
      width: 64px;
      height: 64px;
      border-radius: var(--r-xs);
      overflow: hidden;
      background: var(--surface2);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .list-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .list-info { flex: 1; min-width: 0; }
    .list-title { font-weight: 700; font-size: 14px; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text); }
    .list-meta { color: var(--text3); font-size: 12px; display: flex; gap: 12px; font-weight: 600; }
    .list-actions { display: flex; gap: 7px; flex-shrink: 0; }

    /* ══════════════════════════════════
       MODAL
    ══════════════════════════════════ */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(8px);
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-bg.open { display: flex; animation: fadeIn .2s ease; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      padding: 32px;
      width: 100%;
      max-width: 460px;
      box-shadow: var(--shadow-lg);
      animation: slideUp .3s cubic-bezier(.16,1,.3,1);
    }
    @keyframes slideUp { from{transform:translateY(24px);opacity:0} to{transform:none;opacity:1} }
    .modal h3 { font-size: 18px; font-weight: 900; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); color: var(--text); }
    .modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; }

    /* ══════════════════════════════════
       TOAST
    ══════════════════════════════════ */
    .toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%) translateY(120px);
      background: var(--surface2);
      border: 1px solid var(--border2);
      color: var(--text);
      padding: 14px 30px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 700;
      z-index: 9999;
      transition: transform .4s cubic-bezier(.16,1,.3,1);
      box-shadow: var(--shadow-lg);
      white-space: nowrap;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.ok { background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.3); color: var(--accent3); }
    .toast.err { background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.3); color: #fca5a5; }

    .spin { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,.2); border-top-color: rgba(255,255,255,.8); border-radius: 50%; animation: sp .6s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes sp { to{transform:rotate(360deg)} }

    /* ══════════════════════════════════
       FOOTER
    ══════════════════════════════════ */
    footer {
      background: var(--surface);
      border-top: 1px solid var(--border);
      color: var(--text3);
      text-align: center;
      padding: 32px;
      font-size: 13px;
      margin-top: 80px;
      position: relative;
      z-index: 1;
    }
    footer a { color: var(--text2); text-decoration: none; }
    footer a:hover { color: var(--accent3); }

    /* ── 404 ── */
    .p404 { text-align: center; padding: 100px 20px; }
    .p404-num { font-size: 140px; font-weight: 900; color: var(--surface2); line-height: 1; margin-bottom: 20px; }

    /* ══════════════════════════════════
       ADVANCED EDITOR
    ══════════════════════════════════ */

    /* Editor Layout */
    .editor-pro-wrap {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
      border: 1.5px solid var(--border2);
      border-radius: var(--r-sm);
      overflow: hidden;
      background: var(--surface);
      transition: border-color .2s;
    }
    .editor-pro-wrap:focus-within { border-color: var(--accent); }
    .editor-pro-wrap.split-view {
      grid-template-columns: 1fr 1fr;
    }

    /* Top bar with mode toggles */
    .editor-topbar {
      grid-column: 1/-1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 8px;
    }
    .editor-mode-btns {
      display: flex;
      gap: 4px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-xs);
      padding: 3px;
    }
    .mode-btn {
      padding: 5px 14px;
      border-radius: 5px;
      border: none;
      background: transparent;
      color: var(--text3);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Vazirmatn', sans-serif;
      transition: all .2s;
    }
    .mode-btn.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 6px rgba(34,197,94,.3);
    }
    .editor-stats-bar {
      display: flex;
      gap: 16px;
      font-size: 11px;
      color: var(--text3);
      font-weight: 600;
    }
    .editor-stats-bar span { display: flex; align-items: center; gap: 4px; }
    .editor-stats-bar .stat-good { color: var(--accent); }
    .editor-stats-bar .stat-warn { color: var(--gold); }
    .editor-stats-bar .stat-bad  { color: var(--red); }

    /* Toolbar */
    .editor-toolbar-pro {
      grid-column: 1/-1;
      display: flex;
      gap: 2px;
      padding: 8px 12px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      align-items: center;
    }
    .tb-group {
      display: flex;
      gap: 2px;
      align-items: center;
    }
    .tb-label {
      font-size: 10px;
      color: var(--text3);
      font-weight: 700;
      padding: 0 6px;
      letter-spacing: .5px;
      text-transform: uppercase;
    }

    /* Block inserter */
    .block-inserter {
      display: flex;
      gap: 6px;
      padding: 10px 14px;
      background: rgba(34,197,94,.03);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      grid-column: 1/-1;
    }
    .block-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 50px;
      border: 1px solid var(--border2);
      background: var(--surface2);
      color: var(--text2);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Vazirmatn', sans-serif;
      transition: all .2s;
    }
    .block-btn:hover {
      border-color: var(--accent);
      color: var(--accent3);
      background: rgba(34,197,94,.06);
    }

    /* Editor panes */
    .editor-pane {
      min-height: 380px;
      position: relative;
    }
    .editor-pane-label {
      position: absolute;
      top: 10px;
      left: 14px;
      font-size: 10px;
      font-weight: 700;
      color: var(--text3);
      letter-spacing: .8px;
      text-transform: uppercase;
      pointer-events: none;
      z-index: 2;
    }
    .editor-body-pro {
      min-height: 380px;
      padding: 22px;
      outline: none;
      font-family: 'Vazirmatn', sans-serif;
      font-size: 14px;
      line-height: 1.9;
      color: var(--text);
      direction: rtl;
      height: 100%;
    }
    .editor-body-pro:empty::before { content: attr(data-placeholder); color: var(--text3); }
    .editor-body-pro h1 { font-size:22px;font-weight:900;margin:16px 0 8px;color:var(--text); }
    .editor-body-pro h2 { font-size:18px;font-weight:800;margin:14px 0 6px;padding-right:12px;border-right:3px solid var(--accent);color:var(--text); }
    .editor-body-pro h3 { font-size:15px;font-weight:700;margin:12px 0 4px;color:var(--text); }
    .editor-body-pro blockquote { border-right:4px solid var(--gold);padding:10px 14px;background:rgba(245,158,11,.07);margin:12px 0;border-radius:0 var(--r-xs) var(--r-xs) 0;color:#d6b06a; }
    .editor-body-pro pre { background:#060b09;color:#a3e6c0;padding:16px;border-radius:var(--r-xs);font-family:monospace;font-size:13px;direction:ltr;text-align:left;margin:12px 0; }
    .editor-body-pro code { background:rgba(34,197,94,.08);color:var(--accent3);padding:1px 6px;border-radius:4px;font-family:monospace; }
    .editor-body-pro ul,.editor-body-pro ol { padding-right:24px;margin:8px 0; }
    .editor-body-pro a { color:var(--accent3);text-decoration:underline; }
    .editor-body-pro .info-box { background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.25);border-right:4px solid var(--blue);padding:14px 18px;border-radius:0 var(--r-xs) var(--r-xs) 0;margin:12px 0;color:#93c5fd; }
    .editor-body-pro .warn-box { background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-right:4px solid var(--gold);padding:14px 18px;border-radius:0 var(--r-xs) var(--r-xs) 0;margin:12px 0;color:#fcd34d; }
    .editor-body-pro .success-box { background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.25);border-right:4px solid var(--accent);padding:14px 18px;border-radius:0 var(--r-xs) var(--r-xs) 0;margin:12px 0;color:var(--accent3); }
    .editor-body-pro table { width:100%;border-collapse:collapse;margin:12px 0;font-size:13px; }
    .editor-body-pro th { background:var(--surface2);color:var(--text);font-weight:800;padding:10px 14px;text-align:right;border:1px solid var(--border2); }
    .editor-body-pro td { padding:9px 14px;border:1px solid var(--border);color:var(--text2); }
    .editor-body-pro tr:nth-child(even) td { background:rgba(255,255,255,.02); }

    /* Preview pane */
    .preview-pane {
      border-right: 1px solid var(--border);
      background: var(--bg2);
      overflow-y: auto;
    }
    .preview-inner {
      padding: 22px;
      font-family: 'Vazirmatn', sans-serif;
      font-size: 14px;
      line-height: 1.9;
      color: var(--text2);
      direction: rtl;
    }
    .preview-inner h1 { font-size:22px;font-weight:900;color:var(--text);margin:16px 0 8px; }
    .preview-inner h2 { font-size:18px;font-weight:800;color:var(--text);margin:14px 0 6px;padding-right:12px;border-right:3px solid var(--accent); }
    .preview-inner h3 { font-size:15px;font-weight:700;color:var(--text);margin:12px 0 4px; }
    .preview-inner blockquote { border-right:4px solid var(--gold);padding:10px 14px;background:rgba(245,158,11,.07);margin:12px 0;color:#d6b06a; }
    .preview-inner pre { background:#060b09;color:#a3e6c0;padding:16px;border-radius:var(--r-xs);font-family:monospace;font-size:13px;direction:ltr;text-align:left; }
    .preview-inner code { background:rgba(34,197,94,.08);color:var(--accent3);padding:1px 6px;border-radius:4px;font-family:monospace; }
    .preview-inner table { width:100%;border-collapse:collapse;font-size:13px;margin:12px 0; }
    .preview-inner th { background:var(--surface2);color:var(--text);font-weight:800;padding:10px 14px;border:1px solid var(--border2); }
    .preview-inner td { padding:9px 14px;border:1px solid var(--border);color:var(--text2); }

    /* Editor footer */
    .editor-footer-pro {
      grid-column: 1/-1;
      padding: 8px 16px;
      background: var(--bg);
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--text3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .autosave-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    .autosave-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--text3);
      transition: background .3s;
    }
    .autosave-dot.saved { background: var(--accent); animation: pulse 1.5s ease-out; }
    .autosave-dot.saving { background: var(--gold); animation: spin2 .8s linear infinite; }
    @keyframes spin2 { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

    /* TOC Preview */
    .toc-preview {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-xs);
      padding: 14px;
      margin-top: 8px;
    }
    .toc-preview-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--text3);
      letter-spacing: .8px;
      text-transform: uppercase;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .toc-preview-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 8px;
      border-radius: 5px;
      font-size: 13px;
      color: var(--text2);
      transition: background .15s;
    }
    .toc-preview-item:hover { background: var(--surface3); }
    .toc-preview-item.h2 { font-weight: 700; color: var(--text); }
    .toc-preview-item.h3 { padding-right: 20px; font-size: 12px; color: var(--text3); }
    .toc-count {
      background: rgba(34,197,94,.15);
      color: var(--accent3);
      border-radius: 50px;
      padding: 1px 8px;
      font-size: 10px;
      font-weight: 800;
    }

    /* SEO Score */
    .seo-panel {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 18px;
      margin-top: 16px;
    }
    .seo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .seo-title {
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .seo-score-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 14px;
      border-radius: 50px;
      font-size: 13px;
      font-weight: 900;
    }
    .seo-score-badge.good { background:rgba(34,197,94,.12);color:var(--accent3);border:1px solid rgba(34,197,94,.25); }
    .seo-score-badge.ok   { background:rgba(245,158,11,.12);color:#fcd34d;border:1px solid rgba(245,158,11,.25); }
    .seo-score-badge.bad  { background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25); }
    .seo-checks {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .seo-check {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text2);
    }
    .seo-check .icon { font-size: 13px; flex-shrink: 0; }
    .seo-check.pass .icon::before { content: '✅'; }
    .seo-check.warn .icon::before { content: '⚠️'; }
    .seo-check.fail .icon::before { content: '❌'; }

    /* Tags input */
    .tags-input-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 12px;
      border: 1.5px solid var(--border2);
      border-radius: var(--r-xs);
      background: var(--surface2);
      min-height: 46px;
      cursor: text;
      align-items: center;
      transition: border-color .2s;
    }
    .tags-input-wrap:focus-within { border-color: var(--accent); }
    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      background: rgba(34,197,94,.1);
      border: 1px solid rgba(34,197,94,.25);
      border-radius: 50px;
      font-size: 12px;
      font-weight: 700;
      color: var(--accent3);
    }
    .tag-chip .del { cursor:pointer;font-size:14px;color:var(--text3);transition:color .15s; }
    .tag-chip .del:hover { color: var(--red); }
    .tags-real-input {
      border: none;
      outline: none;
      background: transparent;
      font-family: 'Vazirmatn', sans-serif;
      font-size: 13px;
      color: var(--text);
      min-width: 80px;
      flex: 1;
    }
    .tags-real-input::placeholder { color: var(--text3); }

    /* Article list - advanced */
    .art-list-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 10px;
      transition: all .25s;
      position: relative;
    }
    .art-list-item:hover { border-color: var(--border2); background: var(--surface2); }
    .art-list-thumb {
      width: 72px;
      height: 52px;
      border-radius: var(--r-xs);
      overflow: hidden;
      background: var(--surface2);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    .art-list-thumb img { width:100%;height:100%;object-fit:cover; }
    .art-list-info { flex: 1; min-width: 0; }
    .art-list-title { font-weight: 700; font-size: 14px; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text); }
    .art-list-meta { color: var(--text3); font-size: 11px; display: flex; gap: 10px; flex-wrap: wrap; font-weight: 600; align-items: center; }
    .art-list-meta .badge { background: rgba(34,197,94,.1); border: 1px solid rgba(34,197,94,.2); color: var(--accent3); padding: 2px 8px; border-radius: 50px; font-size: 10px; font-weight: 800; }
    .art-list-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .art-list-preview { font-size: 12px; color: var(--text3); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Read time badge */
    .read-time { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text3); font-weight: 600; }

    /* Slug field */
    .slug-preview {
      font-size: 11px;
      color: var(--text3);
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
      font-family: monospace;
      background: var(--surface3);
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }
    .slug-preview .base { color: var(--text3); }
    .slug-preview .slug { color: var(--accent3); }

    /* Image caption */
    .img-with-caption {
      text-align: center;
      margin: 12px 0;
    }
    .img-with-caption img {
      max-width: 100%;
      border-radius: var(--r-xs);
      border: 1px solid var(--border);
    }
    .img-with-caption figcaption {
      font-size: 12px;
      color: var(--text3);
      margin-top: 6px;
      font-style: italic;
    }

    /* Form sections */
    .form-section {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      overflow: hidden;
      margin-bottom: 18px;
    }
    .form-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
    }
    .form-section-header h4 {
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .form-section-toggle {
      font-size: 12px;
      color: var(--text3);
      transition: transform .2s;
    }
    .form-section-toggle.open { transform: rotate(180deg); }
    .form-section-body {
      padding: 18px;
    }

    /* Two-column form layout */
    .form-cols-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-cols-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    @media(max-width:768px){
      .form-cols-2,.form-cols-3 { grid-template-columns: 1fr; }
      .editor-pro-wrap.split-view { grid-template-columns: 1fr; }
    }

    /* Status indicator */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: var(--bg2);
      border-radius: var(--r-xs);
      font-size: 12px;
      font-weight: 600;
      color: var(--text3);
      border: 1px solid var(--border);
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.green { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
    .status-dot.yellow { background: var(--gold); }
    .status-dot.red { background: var(--red); }

    /* ══════════════════════════════════
       AD PLACEHOLDER
    ══════════════════════════════════ */
    .editor-body #pos-article-display-card-116213 {
      min-height: 64px;
      background: rgba(34,197,94,.05);
      border: 1.5px dashed rgba(34,197,94,.3);
      margin: 16px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--r-xs);
    }
    .editor-body #pos-article-display-card-116213::after {
      content: '📢 جایگاه تبلیغ';
      color: var(--accent3);
      font-size: 13px;
      font-weight: 700;
    }

    /* ══════════════════════════════════
       RESPONSIVE
    ══════════════════════════════════ */
    @media(max-width:768px){
      .admin-layout { grid-template-columns: 1fr; }
      .admin-sidebar { display: none; }
      .f-grid { grid-template-columns: 1fr; }
      .settings-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .slide-content { padding: 44px 28px; }
      .hdr { padding: 0 18px; }
      .main { padding: 40px 18px; }
      .detail-wrap { padding: 40px 18px; }
    }
  </style>
</head>
<body>

<script>
  const SB_URL  = 'https://tjztualnmoliusuoxpdx.supabase.co'
  const SB_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqenR1YWxubW9saXVzdW94cGR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzIyNDksImV4cCI6MjA4NzAwODI0OX0.PSMSMyUpejqXs3SOv0jLB15SMobyh6PKWvQQz_VEsBw'
  const PER_PAGE = 6
  const BASE_URL = 'https://mohamadalighane.github.io/daramad-noo/'
</script>

<div id="readProgress"></div>
<button id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="بازگشت به بالا">↑</button>

<!-- HEADER -->
<header id="hdr">
  <div class="hdr">
    <div class="logo" onclick="go('home')">
      <div class="logo-mark">💰</div>
      <div class="logo-text">
        <div class="logo-name" id="siteNameDisplay">بلاگ یار</div>
        <div class="logo-sub" id="siteDescDisplay">مقالات </div>
      </div>
    </div>
    <nav class="hdr-nav">
      <button class="nav-link" onclick="go('home')">🏠 خانه</button>
      <button id="themeToggle" onclick="toggleTheme()" title="تغییر تم">🌙</button>
      <button class="nav-link primary" onclick="go('admin')">⚙مدیر</button>
    </nav>
  </div>
</header>

<div class="toast" id="toast"></div>

<!-- LINK MODAL -->
<div class="modal-bg" id="linkModal">
  <div class="modal">
    <h3>🔗 افزودن لینک</h3>
    <div class="f-group">
      <label class="f-label">متن لینک</label>
      <input class="f-input" id="linkText" placeholder="متن نمایشی">
    </div>
    <div class="f-group">
      <label class="f-label">آدرس URL</label>
      <input class="f-input" id="linkUrl" placeholder="https://...">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('linkModal')">انصراف</button>
      <button class="btn btn-primary" onclick="insertLink()">افزودن</button>
    </div>
  </div>
</div>

<!-- HOME -->
<div class="page active" id="pg-home">
  <div class="slider-section" id="sliderSection">
    <div class="slides" id="slidesTrack"></div>
    <div class="slider-arrows">
      <button class="slider-arrow" onclick="slideNext()">‹</button>
      <button class="slider-arrow" onclick="slidePrev()">›</button>
    </div>
    <div class="slider-controls" id="sliderDots"></div>
  </div>

  <div class="main">
    <div style="margin-bottom:36px">
      <div class="search-bar">
        <input class="search-input" id="searchInput" type="text"
          placeholder="جستجو در مقالات..." oninput="onSearch(this.value)">
        <span class="search-icon">🔍</span>
      </div>
    </div>
    <div class="section-header">
      <div class="section-title">آخرین مقالات</div>
      <div class="art-count" id="artCount"></div>
    </div>
    <div class="cat-filter" id="catFilter"></div>
    <div class="grid" id="artGrid"></div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<!-- DETAIL -->
<div class="page detail-outer" id="pg-detail">
  <div class="detail-wrap">
    <button class="back-btn" onclick="go('home')">← بازگشت به مقالات</button>
    <div id="detailBody">
      <div id="pos-article-display-card-116213"></div>
      <div id="pos-article-text-116230"></div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div class="page" id="pg-login">
  <div class="login-page">
    <div class="login-card">
      <div class="login-icon">🔐</div>
      <div class="login-title">ورود به پنل مدیریت</div>
      <div class="login-sub">با ایمیل و رمز Supabase وارد شوید</div>
      <div class="alert alert-err" id="loginErr"></div>
      <div class="f-group">
        <label class="f-label">ایمیل</label>
        <input class="f-input" id="loginEmail" type="email" placeholder="admin@daramad.com">
      </div>
      <div class="f-group">
        <label class="f-label">رمز عبور</label>
        <input class="f-input" id="loginPass" type="password" placeholder="••••••••"
          onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="btn btn-primary" id="loginBtn"
        style="width:100%;padding:15px;font-size:15px;justify-content:center;margin-top:6px"
        onclick="doLogin()">ورود به سیستم</button>
      <div style="text-align:center;margin-top:20px">
        <button class="btn btn-ghost" onclick="go('home')" style="font-size:12px">← بازگشت</button>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div class="page" id="pg-admin">
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-text">درآمد نو</div>
        <div class="sidebar-logo-sub">پنل مدیریت</div>
      </div>
      <nav class="sidebar-nav">
        <div class="sidebar-section">مقالات</div>
        <button class="sidebar-item active" id="sb-articles" onclick="showAdminPanel('articles')">
          <span class="icon">📋</span> مدیریت مقالات
        </button>
        <button class="sidebar-item" id="sb-new-article" onclick="showAdminPanel('new-article')">
          <span class="icon">✏️</span> مقاله جدید
        </button>
        <div class="sidebar-section">سایت</div>
        <button class="sidebar-item" id="sb-slider" onclick="showAdminPanel('slider')">
          <span class="icon">🎠</span> مدیریت اسلایدر
        </button>
        <button class="sidebar-item" id="sb-settings" onclick="showAdminPanel('settings')">
          <span class="icon">⚙️</span> تنظیمات سایت
        </button>
        <div class="sidebar-section">گزارش</div>
        <button class="sidebar-item" id="sb-stats" onclick="showAdminPanel('stats')">
          <span class="icon">📊</span> آمار
        </button>
      </nav>
      <div class="sidebar-footer">
        <button class="sidebar-item" onclick="go('home')" style="margin-bottom:6px">
          <span class="icon">🏠</span> مشاهده سایت
        </button>
        <button class="sidebar-item" onclick="doLogout()">
          <span class="icon">🚪</span> خروج
        </button>
      </div>
    </aside>
    <div class="admin-main">
      <div class="admin-topbar">
        <div class="admin-topbar-title" id="adminTopbarTitle">مدیریت مقالات</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="go('home')" style="font-size:12px">🏠 سایت</button>
          <button class="btn btn-danger" onclick="doLogout()" style="font-size:12px">خروج</button>
        </div>
      </div>
      <div class="admin-content" id="adminContent"></div>
    </div>
  </div>
</div>

<div id="pos-article-display-116132"></div>

<!-- 404 -->
<div class="page" id="pg-404">
  <div class="p404">
    <div class="p404-num">404</div>
    <h2 style="font-size:28px;font-weight:900;margin-bottom:12px;color:var(--text)">صفحه یافت نشد</h2>
    <p style="color:var(--text3);margin-bottom:32px">صفحه‌ای که دنبالش بودید وجود ندارد.</p>
    <button class="btn btn-primary" onclick="go('home')">🏠 بازگشت به خانه</button>
  </div>
</div>

<footer>
  <p>ساخته شده با ❤️ | <span id="footerSiteName">درآمد نو</span> &copy; ۱۴۰۳</p>
</footer>

<script>
// ══════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════
let sb = null
const sbReady = (() => {
  if (!SB_KEY || SB_KEY === 'YOUR_ANON_KEY_HERE') return false
  try { sb = window.supabase.createClient(SB_URL, SB_KEY); return true }
  catch { return false }
})()

// ══════════════════════════════════════════
//  SITE SETTINGS
// ══════════════════════════════════════════
const SETTINGS_KEY = 'daramad_settings'
function getSiteSettings() {
  try {
    return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {
      siteName: 'درآمد نو',
      siteDesc: 'مقالات کسب درآمد',
      accentColor: '#22c55e',
      footerText: 'ساخته شده با ❤️ | درآمد نو'
    }
  } catch { return { siteName:"بلاگ یار", siteDesc:'مقالات', accentColor:'#22c55e', footerText:'ساخته شده با ❤️' } }
}
function saveSiteSettings(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)) }
function applySiteSettings() {
  const s = getSiteSettings()
  document.getElementById('siteNameDisplay').textContent = s.siteName
  document.getElementById('siteDescDisplay').textContent = s.siteDesc
  document.getElementById('footerSiteName').textContent = s.siteName
  document.title = s.siteName + ' | مقالات کسب درآمد'
  document.documentElement.style.setProperty('--accent', s.accentColor)
  document.documentElement.style.setProperty('--accent2', darkenColor(s.accentColor, 10))
}
function darkenColor(hex, pct) {
  const n = parseInt(hex.slice(1), 16)
  const r = Math.max(0, (n >> 16) - pct * 2)
  const g = Math.max(0, ((n >> 8) & 0xff) - pct * 2)
  const b = Math.max(0, (n & 0xff) - pct * 2)
  return '#' + [r,g,b].map(v => v.toString(16).padStart(2,'0')).join('')
}

// ══════════════════════════════════════════
//  CATEGORIES
// ══════════════════════════════════════════
const DEFAULT_CATS = ['کسب درآمد','فریلنسری','سرمایه‌گذاری','کارآفرینی','بازاریابی','آموزش']
const CAT_KEY = 'daramad_cats'
function getCats() { try { return JSON.parse(localStorage.getItem(CAT_KEY)) || DEFAULT_CATS } catch { return DEFAULT_CATS } }
function saveCats(c) { localStorage.setItem(CAT_KEY, JSON.stringify(c)) }
function addCategory() {
  const inp = document.getElementById('newCatInput')
  const val = inp.value.trim()
  if (!val) return
  const cats = getCats()
  if (cats.includes(val)) { toast('این دسته‌بندی قبلاً وجود دارد', 'err'); return }
  cats.push(val); saveCats(cats); inp.value = ''
  renderCatAdmin(); renderCatSelect()
  toast('دسته‌بندی اضافه شد ✓', 'ok')
}
function deleteCategory(cat) {
  if (!confirm(`دسته‌بندی "${cat}" حذف شود؟`)) return
  saveCats(getCats().filter(c => c !== cat))
  renderCatAdmin(); renderCatSelect()
}
function renderCatSelect() {
  const sel = document.getElementById('fCat')
  if (!sel) return
  const cur = sel.value
  sel.innerHTML = getCats().map(c => `<option value="${x(c)}">${x(c)}</option>`).join('')
  if (cur) sel.value = cur
}
function renderCatAdmin() {
  const el = document.getElementById('catTagsAdmin')
  if (!el) return
  el.innerHTML = getCats().map(c =>
    `<span class="cat-tag">${x(c)}<span class="del-cat" onclick="deleteCategory('${x(c)}')">×</span></span>`
  ).join('')
}

// ══════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════
let currentPage = 1, totalCount = 0, searchQuery = '', activeCat = ''
let uploadedImageUrl = '', savedRange = null
let slideIndex = 0, slideTimer = null, slides = []

// ══════════════════════════════════════════
//  NAVIGATION
// ══════════════════════════════════════════
function go(page, id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'))
  document.getElementById('hdr').style.display = page === 'login' ? 'none' : ''
  if (page === 'home') {
    show('pg-home'); currentPage = 1; resetSEO()
    loadArticles(); loadSlider()
    history.pushState(null, '', location.pathname)
  } else if (page === 'detail' && id) {
    show('pg-detail'); loadDetail(id)
    history.pushState(null, '', '?article=' + id)
  } else if (page === 'admin') {
    if (!sbReady) { alert('⚠️ کلید Supabase را وارد کن'); return }
    sb.auth.getSession().then(({ data: { session } }) => {
      if (session) { show('pg-admin'); showAdminPanel('articles') }
      else { document.getElementById('hdr').style.display = 'none'; show('pg-login') }
    })
  } else if (page === 'login') {
    document.getElementById('hdr').style.display = 'none'; show('pg-login')
  } else { show('pg-404') }
  window.scrollTo(0, 0)
}
function show(id) { document.getElementById(id).classList.add('active') }

// ══════════════════════════════════════════
//  AUTH
// ══════════════════════════════════════════
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim()
  const pass  = document.getElementById('loginPass').value
  const errEl = document.getElementById('loginErr')
  const btn   = document.getElementById('loginBtn')
  hide(errEl)
  if (!email || !pass) { showAlert(errEl, 'ایمیل و رمز را وارد کنید'); return }
  btn.innerHTML = '<span class="spin"></span> در حال ورود...'
  btn.disabled = true
  const { error } = await sb.auth.signInWithPassword({ email, password: pass })
  btn.innerHTML = 'ورود به سیستم'; btn.disabled = false
  if (error) { showAlert(errEl, error.message.includes('not confirmed') ? 'ایمیل تأیید نشده' : 'ایمیل یا رمز اشتباه'); return }
  document.getElementById('hdr').style.display = ''
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'))
  show('pg-admin'); showAdminPanel('articles')
  toast('خوش آمدید ✓', 'ok')
}
async function doLogout() { await sb.auth.signOut(); go('home'); toast('خارج شدید', 'ok') }

// ══════════════════════════════════════════
//  SLIDER
// ══════════════════════════════════════════
const SLIDE_KEY = 'daramad_slides'
function getSlides() { try { return JSON.parse(localStorage.getItem(SLIDE_KEY)) || [] } catch { return [] } }
function saveSlides(s) { localStorage.setItem(SLIDE_KEY, JSON.stringify(s)) }

function loadSlider() {
  slides = getSlides()
  const track = document.getElementById('slidesTrack')
  const dots  = document.getElementById('sliderDots')
  const section = document.getElementById('sliderSection')
  if (!slides.length) { section.style.display = 'none'; return }
  section.style.display = 'block'
  track.innerHTML = slides.map((s, i) => `
    <div class="slide ${i === 0 ? 'active' : ''}">
      <div class="slide-bg" style="background-image:url('${x(s.image || '')}');${!s.image ? 'background:linear-gradient(135deg,#0a0f0d,#131a15)' : ''}"></div>
      <div class="slide-content">
        ${s.badge ? `<div class="slide-badge">✨ ${x(s.badge)}</div>` : ''}
        <h2 class="slide-title">${x(s.title)}</h2>
        ${s.desc ? `<p class="slide-desc">${x(s.desc)}</p>` : ''}
        ${s.btn && s.link ? `<button class="slide-btn" onclick="go('detail',${s.link})">${x(s.btn)}</button>` : ''}
      </div>
    </div>`).join('')
  dots.innerHTML = slides.map((_, i) =>
    `<button class="dot ${i === 0 ? 'active' : ''}" onclick="goSlide(${i})"></button>`
  ).join('')
  slideIndex = 0
  clearInterval(slideTimer)
  if (slides.length > 1) slideTimer = setInterval(slideNext, 5000)
}
function goSlide(i) {
  const track = document.getElementById('slidesTrack')
  const allSlides = track.querySelectorAll('.slide')
  const allDots   = document.getElementById('sliderDots').querySelectorAll('.dot')
  allSlides.forEach((s, j) => { s.classList.toggle('active', j === i) })
  allDots.forEach((d, j) => { d.classList.toggle('active', j === i) })
  track.style.transform = `translateX(${i * 100}%)`
  slideIndex = i
  clearInterval(slideTimer)
  if (slides.length > 1) slideTimer = setInterval(slideNext, 5000)
}
function slideNext() { goSlide((slideIndex + 1) % Math.max(slides.length, 1)) }
function slidePrev() { goSlide((slideIndex - 1 + Math.max(slides.length, 1)) % Math.max(slides.length, 1)) }

// ══════════════════════════════════════════
//  ARTICLES
// ══════════════════════════════════════════
let searchTimer
function onSearch(v) {
  clearTimeout(searchTimer)
  searchTimer = setTimeout(() => { searchQuery = v; currentPage = 1; loadArticles() }, 300)
}

async function loadArticles() {
  const grid = document.getElementById('artGrid')
  const cnt  = document.getElementById('artCount')
  const pag  = document.getElementById('pagination')
  if (!sbReady) {
    grid.innerHTML = `<div class="empty"><div class="empty-icon">⚙️</div><h3>کلید Supabase وارد نشده</h3><p>مقدار YOUR_ANON_KEY_HERE را در فایل جایگزین کن</p></div>`
    return
  }
  grid.innerHTML = spinning(); pag.innerHTML = ''
  loadCatFilter()
  const from = (currentPage - 1) * PER_PAGE
  const to   = from + PER_PAGE - 1
  let q = sb.from('articles').select('*', { count: 'exact' })
    .order('created_at', { ascending: false }).range(from, to)
  if (searchQuery.trim()) q = q.or(`title.ilike.%${searchQuery}%,short_description.ilike.%${searchQuery}%`)
  if (activeCat) q = q.eq('category', activeCat)
  const { data, error, count } = await q
  if (error) { grid.innerHTML = errHtml(error.message); return }
  totalCount = count || 0
  cnt.textContent = totalCount > 0 ? `${totalCount} مقاله` : ''
  if (!data || !data.length) {
    grid.innerHTML = `<div class="empty"><div class="empty-icon">${searchQuery || activeCat ? '🔍' : '📂'}</div>
      <h3>${searchQuery || activeCat ? 'مقاله‌ای یافت نشد' : 'هنوز مقاله‌ای نیست'}</h3>
      <p>${searchQuery || activeCat ? 'فیلتر را تغییر دهید' : 'از پنل ادمین مقاله اضافه کنید'}</p>
    </div>`
    return
  }
  grid.innerHTML = data.map(a => `
    <div class="card" onclick="go('detail',${a.id})">
      <div class="card-img-wrap">
        ${a.image
          ? `<img class="card-img" src="${x(a.image)}" alt="${x(a.title)}" loading="lazy"
                onerror="this.style.display='none';this.parentElement.querySelector('.card-ph').style.display='flex'">`
          : ''}
        <div class="card-ph" ${a.image ? 'style="display:none"' : ''}>📄</div>
        ${a.category ? `<div class="card-cat-badge">${x(a.category)}</div>` : ''}
      </div>
      <div class="card-body">
        <div class="card-date">📅 ${fd(a.created_at)}</div>
        <div class="card-title">${x(a.title)}</div>
        <div class="card-desc">${stripHtml(a.short_description)}</div>
        <div class="card-foot">
          <span class="read-more">مشاهده بیشتر</span>
        </div>
      </div>
    </div>`).join('')

  const totalPages = Math.ceil(totalCount / PER_PAGE)
  if (totalPages > 1) renderPagination(currentPage, totalPages)
}

async function loadCatFilter() {
  const el = document.getElementById('catFilter')
  const { data } = await sb.from('articles').select('category').not('category', 'is', null)
  if (!data) return
  const cats = [...new Set(data.map(r => r.category).filter(Boolean))]
  el.innerHTML = `<button class="cat-chip ${!activeCat ? 'active' : ''}" onclick="filterCat('')">همه</button>` +
    cats.map(c => `<button class="cat-chip ${activeCat === c ? 'active' : ''}" onclick="filterCat('${x(c)}')">${x(c)}</button>`).join('')
}
function filterCat(cat) { activeCat = cat; currentPage = 1; loadArticles() }

function renderPagination(cur, total) {
  const pag = document.getElementById('pagination')
  let html = `<button class="pg-btn" onclick="goPage(${cur-1})" ${cur===1?'disabled':''}>›</button>`
  for (let i = 1; i <= total; i++) {
    if (i===1||i===total||(i>=cur-2&&i<=cur+2)) html += `<button class="pg-btn ${i===cur?'active':''}" onclick="goPage(${i})">${i}</button>`
    else if (i===cur-3||i===cur+3) html += `<span class="pg-sep">...</span>`
  }
  html += `<button class="pg-btn" onclick="goPage(${cur+1})" ${cur===total?'disabled':''}>‹</button>`
  html += `<span class="pg-sep" style="font-size:12px">${cur} از ${total}</span>`
  pag.innerHTML = html
}
function goPage(p) { currentPage = p; loadArticles(); window.scrollTo({ top: 0, behavior: 'smooth' }) }

// ══════════════════════════════════════════
//  DETAIL
// ══════════════════════════════════════════
async function loadDetail(id) {
  const body = document.getElementById('detailBody')
  body.innerHTML = spinning(true)
  const { data: a, error } = await sb.from('articles').select('*').eq('id', id).single()
  if (error || !a) {
    body.innerHTML = `<div style="text-align:center;padding:60px;color:var(--text3)"><div style="font-size:56px;margin-bottom:16px">😕</div><p>مقاله یافت نشد</p></div>`
    return
  }
  document.title = a.title + ' | ' + getSiteSettings().siteName
  setArticleSEO(a)
  const embed = ytEmbed(a.video_link)
  const videoHtml = a.video_link
    ? (embed
        ? `<div class="video-frame"><iframe src="${embed}" allowfullscreen loading="lazy"></iframe></div>`
        : `<a class="video-link-btn" href="${x(a.video_link)}" target="_blank" rel="noopener">▶ مشاهده ویدیو</a>`)
    : ''

  const isBookmarked = isArticleBookmarked(a.id)
  const wc = calcWordCount(a.full_content || '')
  const readMin = Math.max(1, Math.ceil(wc / 200))

  body.innerHTML = `
    ${a.image ? `<img class="detail-img" src="${x(a.image)}" alt="${x(a.title)}" loading="lazy">` : ''}
    <h1 class="detail-title">${x(a.title)}</h1>
    <div class="detail-meta">
      <span class="detail-meta-item">📅 ${fd(a.created_at)}</span>
      <span class="detail-meta-item">⏱ ${readMin} دقیقه مطالعه</span>
      <span class="detail-meta-item">📝 ${wc} کلمه</span>
      ${a.category ? `<span class="detail-badge">${x(a.category)}</span>` : ''}
    </div>
    <div class="detail-actions">
      <button class="btn btn-primary" onclick="downloadPDF()">📄 دانلود PDF</button>
      <button class="bookmark-btn ${isBookmarked ? 'saved' : ''}" id="bookmarkBtn" onclick="toggleBookmark(${a.id},'${x(a.title)}','${x(a.image||'')}')">
        ${isBookmarked ? '🔖 ذخیره شده' : '🔖 ذخیره'}
      </button>
      <button class="btn btn-ghost" onclick="copyLink()" id="copyLinkBtn">🔗 کپی لینک</button>
      <a class="btn btn-ghost" id="shareWa" href="" target="_blank" rel="noopener">📲 واتساپ</a>
      <a class="btn btn-ghost" id="shareTg" href="" target="_blank" rel="noopener">✈️ تلگرام</a>
    </div>
    ${videoHtml}
    <div class="rich-content" id="articleContent">${processContent(a.full_content)}</div>
    <div id="relatedSection"></div>
    <div id="commentsSection"></div>`

  window._currentArticle = a
  const url = encodeURIComponent(location.origin + location.pathname + '?article=' + a.id)
  const txt = encodeURIComponent(a.title + ' | ' + getSiteSettings().siteName)
  document.getElementById('shareWa').href = `https://wa.me/?text=${txt}%20${url}`
  document.getElementById('shareTg').href = `https://t.me/share/url?url=${url}&text=${txt}`

  setTimeout(() => {
    // Code copy buttons
    document.querySelectorAll('#articleContent pre').forEach(pre => {
      const wrap = document.createElement('div'); wrap.className = 'code-block'
      pre.parentNode.insertBefore(wrap, pre); wrap.appendChild(pre)
      const btn = document.createElement('button'); btn.className = 'copy-btn'; btn.textContent = '📋 کپی'
      btn.onclick = () => { navigator.clipboard.writeText(pre.textContent); btn.textContent = '✅ کپی شد'; setTimeout(() => btn.textContent = '📋 کپی', 2000) }
      wrap.appendChild(btn)
    })

    // Make article-toc collapsible
    document.querySelectorAll('#articleContent .article-toc').forEach(toc => {
      const titleEl = toc.querySelector('div')
      const listEl  = toc.querySelector('ol')
      if (!titleEl || !listEl) return
      // Wrap in toggle structure
      toc.innerHTML = `
        <div class="toc-toggle-header" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.toc-toggle-arrow').classList.toggle('open')">
          <div class="toc-toggle-title">${titleEl.innerHTML}</div>
          <span class="toc-toggle-arrow">▾</span>
        </div>
        <div class="toc-body open">
          <ol>${listEl.innerHTML}</ol>
        </div>`
      // Add h3 class to indented items
      toc.querySelectorAll('.toc-body ol li.h3').forEach(li => {
        const a = li.querySelector('a')
        if (a) a.style.paddingRight = '20px'
      })
    })

    // Heading anchor links
    document.querySelectorAll('#articleContent h2, #articleContent h3').forEach(h => {
      if (!h.id) return
      h.style.cursor = 'pointer'
      h.title = 'کلیک برای کپی لینک'
      h.onclick = () => {
        navigator.clipboard.writeText(location.href.split('#')[0] + '#' + h.id)
        toast('لینک کپی شد ✓', 'ok')
      }
    })

    // Load related articles
    loadRelatedArticles(a)
    // Load comments
    renderComments(a.id)
    // Init read progress
    initReadProgress()
  }, 120)
}

// ══════════════════════════════════════════
//  COLLAPSIBLE TOC in generator too
// ══════════════════════════════════════════
// Override generateTOCHtml to produce collapsible version
window._generateTOCHtml = function(toc) {
  if (!toc || !toc.length) return null
  const items = toc.map(item =>
    `<li class="${item.tag}">
      <a href="#${item.id}" style="color:var(--text2);text-decoration:none;display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;transition:all .2s;" 
         ${item.tag==='h3'?'style="padding-right:20px"':''}>
        <span style="color:var(--accent3);font-size:10px">${item.tag==='h2'?'■':'○'}</span>${item.text}
      </a>
    </li>`
  ).join('')
  return `<nav class="article-toc">
    <div class="toc-toggle-header" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.toc-toggle-arrow').classList.toggle('open')">
      <div class="toc-toggle-title">📑 فهرست مطالب</div>
      <span class="toc-toggle-arrow open">▾</span>
    </div>
    <div class="toc-body open">
      <ol>${items}</ol>
    </div>
  </nav><p><br></p>`
}

// ══════════════════════════════════════════
//  READ PROGRESS
// ══════════════════════════════════════════
function initReadProgress() {
  const bar = document.getElementById('readProgress')
  if (!bar) return
  bar.style.width = '0%'
  const updateProgress = () => {
    const content = document.getElementById('articleContent')
    if (!content) return
    const rect = content.getBoundingClientRect()
    const contentHeight = content.offsetHeight
    const scrolled = Math.max(0, -rect.top)
    const pct = Math.min(100, (scrolled / (contentHeight - window.innerHeight + 200)) * 100)
    bar.style.width = Math.max(0, pct) + '%'
  }
  window.removeEventListener('scroll', window._progressHandler)
  window._progressHandler = updateProgress
  window.addEventListener('scroll', updateProgress, { passive: true })
}

// ══════════════════════════════════════════
//  BOOKMARKS
// ══════════════════════════════════════════
const BM_KEY = 'daramad_bookmarks'
function getBookmarks() { try { return JSON.parse(localStorage.getItem(BM_KEY)) || [] } catch { return [] } }
function saveBookmarks(b) { localStorage.setItem(BM_KEY, JSON.stringify(b)) }
function isArticleBookmarked(id) { return getBookmarks().some(b => b.id == id) }

function toggleBookmark(id, title, image) {
  const bms = getBookmarks()
  const btn = document.getElementById('bookmarkBtn')
  const idx = bms.findIndex(b => b.id == id)
  if (idx >= 0) {
    bms.splice(idx, 1)
    saveBookmarks(bms)
    if (btn) { btn.textContent = '🔖 ذخیره'; btn.classList.remove('saved') }
    toast('از نشانک‌ها حذف شد', 'ok')
  } else {
    bms.unshift({ id, title, image, savedAt: Date.now() })
    saveBookmarks(bms)
    if (btn) { btn.innerHTML = '🔖 ذخیره شده'; btn.classList.add('saved') }
    toast('مقاله ذخیره شد 🔖', 'ok')
  }
}

// ══════════════════════════════════════════
//  RELATED ARTICLES
// ══════════════════════════════════════════
async function loadRelatedArticles(article) {
  const section = document.getElementById('relatedSection')
  if (!section || !sbReady) return
  let q = sb.from('articles').select('id,title,image,created_at,category').neq('id', article.id).limit(6)
  if (article.category) q = q.eq('category', article.category)
  const { data } = await q
  let related = data || []
  // If not enough with same category, get any
  if (related.length < 3 && article.category) {
    const { data: more } = await sb.from('articles').select('id,title,image,created_at,category')
      .neq('id', article.id).limit(6)
    related = [...related, ...(more || []).filter(m => !related.find(r => r.id === m.id))].slice(0, 4)
  }
  if (!related.length) return
  section.innerHTML = `
    <div class="related-section">
      <div class="related-title">📚 مقالات مرتبط</div>
      <div class="related-grid">
        ${related.slice(0,4).map(r => `
          <div class="related-card" onclick="go('detail',${r.id})">
            <div class="related-thumb">
              ${r.image
                ? `<img src="${x(r.image)}" alt="${x(r.title)}" loading="lazy" onerror="this.parentElement.textContent='📄'">`
                : '📄'}
            </div>
            <div class="related-body">
              <div class="related-card-title">${x(r.title)}</div>
              <div class="related-card-date">📅 ${fd(r.created_at)}</div>
            </div>
          </div>`).join('')}
      </div>
    </div>`
}

// ══════════════════════════════════════════
//  COMMENTS (localStorage)
// ══════════════════════════════════════════
function getComments(articleId) {
  try { return JSON.parse(localStorage.getItem('comments_' + articleId)) || [] } catch { return [] }
}
function saveComments(articleId, comments) {
  localStorage.setItem('comments_' + articleId, JSON.stringify(comments))
}

function renderComments(articleId) {
  const section = document.getElementById('commentsSection')
  if (!section) return
  const comments = getComments(articleId)
  section.innerHTML = `
    <div class="comments-section">
      <div class="comments-title">
        💬 نظرات
        <span class="comment-count">${comments.length}</span>
      </div>
      <div class="comment-form">
        <div class="comment-form-grid">
          <input class="f-input" id="cName" placeholder="نام شما *" style="font-size:13px">
          <input class="f-input" id="cEmail" placeholder="ایمیل (اختیاری)" style="font-size:13px">
        </div>
        <textarea class="comment-textarea" id="cText" placeholder="نظر خود را بنویسید..."></textarea>
        <button class="btn btn-primary" onclick="submitComment(${articleId})">ارسال نظر ✓</button>
      </div>
      <div id="commentsList">
        ${comments.length === 0
          ? `<div style="text-align:center;padding:32px;color:var(--text3)">
              <div style="font-size:36px;margin-bottom:10px">💬</div>
              <p>اولین نفری باشید که نظر می‌دهد</p>
            </div>`
          : comments.map(c => `
            <div class="comment-item">
              <div class="comment-header">
                <div class="comment-avatar">${c.name.charAt(0)}</div>
                <div>
                  <div class="comment-author">${x(c.name)}</div>
                  <div class="comment-date">${new Date(c.date).toLocaleDateString('fa-IR')}</div>
                </div>
              </div>
              <div class="comment-body">${x(c.text)}</div>
            </div>`).join('')
        }
      </div>
    </div>`
}

function submitComment(articleId) {
  const name = document.getElementById('cName')?.value.trim()
  const text = document.getElementById('cText')?.value.trim()
  if (!name) { toast('نام را وارد کنید', 'err'); return }
  if (!text) { toast('متن نظر را بنویسید', 'err'); return }
  const comments = getComments(articleId)
  comments.unshift({ name, text, date: Date.now(), id: Date.now() })
  saveComments(articleId, comments)
  renderComments(articleId)
  toast('نظر شما ثبت شد ✓', 'ok')
}

// ══════════════════════════════════════════
//  THEME TOGGLE
// ══════════════════════════════════════════
function toggleTheme() {
  const isLight = document.body.classList.toggle('light-theme')
  localStorage.setItem('daramad_theme', isLight ? 'light' : 'dark')
  const btn = document.getElementById('themeToggle')
  if (btn) btn.textContent = isLight ? '☀️' : '🌙'
}
function loadTheme() {
  const saved = localStorage.getItem('daramad_theme')
  if (saved === 'light') {
    document.body.classList.add('light-theme')
    const btn = document.getElementById('themeToggle')
    if (btn) btn.textContent = '☀️'
  }
}

function processContent(html) {
  if (!html) return ''
  if (!/<[a-z][\s\S]*>/i.test(html)) {
    return html.split('\n').map(l => l.trim() ? '<p>' + x(l) + '</p>' : '').filter(Boolean).join('')
  }
  return html
}

function copyLink() {
  navigator.clipboard.writeText(location.href)
  const btn = document.getElementById('copyLinkBtn')
  btn.textContent = '✅ کپی شد'; setTimeout(() => btn.textContent = '🔗 کپی لینک', 2500)
}

// ══════════════════════════════════════════
//  PDF
// ══════════════════════════════════════════
async function downloadPDF() {
  const a = window._currentArticle
  if (!a) return
  toast('در حال ساخت PDF...', '')
  const div = document.createElement('div')
  div.style.cssText = 'position:fixed;top:-9999px;left:0;width:794px;background:#fff;font-family:Vazirmatn,sans-serif;direction:rtl;'
  const s = getSiteSettings()
  div.innerHTML = `
    <div style="background:${s.accentColor};color:#fff;padding:16px 36px;display:flex;justify-content:space-between;align-items:center;font-size:13px;font-family:Vazirmatn,sans-serif">
      <span style="font-weight:900;font-size:16px">${x(s.siteName)}</span>
      <span>${fd(a.created_at)}</span>
    </div>
    <div style="padding:36px 48px 48px;font-family:Vazirmatn,sans-serif">
      ${a.image ? `<img src="${a.image}" crossorigin="anonymous" style="width:100%;max-height:320px;object-fit:cover;border-radius:12px;margin-bottom:28px;display:block">` : ''}
      <h1 style="font-size:26px;font-weight:900;margin-bottom:14px;line-height:1.35;color:#111827;font-family:Vazirmatn,sans-serif">${x(a.title)}</h1>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:20px;font-size:12px;color:#9ca3af;font-family:Vazirmatn,sans-serif">
        <span>📅 ${fd(a.created_at)}</span>
        ${a.category ? `<span style="background:#dcfce7;color:#16a34a;padding:3px 12px;border-radius:20px;font-weight:700">${x(a.category)}</span>` : ''}
      </div>
      <div style="background:#fffbeb;border-right:4px solid #d97706;padding:14px 18px;border-radius:0 8px 8px 0;margin-bottom:28px;font-size:13px;color:#374151;font-style:italic;line-height:1.7;font-family:Vazirmatn,sans-serif">
        ${x(a.short_description)}
      </div>
      <div style="color:#374151;line-height:1.9;font-size:14px;font-family:Vazirmatn,sans-serif">${a.full_content || ''}</div>
      <div style="margin-top:48px;padding-top:16px;border-top:1px solid #e5e7eb;font-size:11px;color:#9ca3af;text-align:center;font-family:Vazirmatn,sans-serif">
        ${x(s.siteName)} | ${BASE_URL}
      </div>
    </div>`
  document.body.appendChild(div)
  try {
    await new Promise(r => setTimeout(r, 400))
    const canvas = await html2canvas(div, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#fff', logging: false, width: 794 })
    document.body.removeChild(div)
    const { jsPDF } = window.jspdf
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' })
    const pw = 210, ph = 297
    const imgH = (canvas.height * pw) / canvas.width
    let y = 0, page = 0
    const img = canvas.toDataURL('image/jpeg', 0.92)
    while (y < imgH) {
      if (page > 0) doc.addPage()
      doc.addImage(img, 'JPEG', 0, -y, pw, imgH)
      y += ph; page++
    }
    doc.save(a.title + '.pdf')
    toast('PDF دانلود شد ✓', 'ok')
  } catch (e) {
    if (document.body.contains(div)) document.body.removeChild(div)
    toast('خطا در ساخت PDF', 'err'); console.error(e)
  }
}

// ══════════════════════════════════════════
//  IMAGE UPLOAD
// ══════════════════════════════════════════
async function handleImageFile(input) {
  const file = input.files[0]
  if (!file) return
  if (file.size > 5 * 1024 * 1024) { toast('حجم عکس بیشتر از ۵ مگابایت', 'err'); return }
  const reader = new FileReader()
  reader.onload = e => {
    const p = document.getElementById('uploadPreview')
    if (p) { p.src = e.target.result; p.style.display = 'block' }
    const ph = document.getElementById('uploadPlaceholder')
    if (ph) ph.style.display = 'none'
  }
  reader.readAsDataURL(file)
  const { data: { session } } = await sb.auth.getSession()
  if (!session) { toast('برای آپلود باید لاگین باشی', 'err'); return }
  const bar = document.getElementById('uploadBar')
  const barWrap = document.getElementById('uploadBarWrap')
  if (barWrap) barWrap.style.display = 'block'
  if (bar) bar.style.width = '45%'
  const ext = file.name.split('.').pop()
  const fileName = Date.now() + '-' + Math.random().toString(36).slice(2) + '.' + ext
  if (bar) bar.style.width = '75%'
  const { error } = await sb.storage.from('article-images').upload(fileName, file, { cacheControl: '3600' })
  if (bar) bar.style.width = '100%'
  if (error) { toast('خطا در آپلود: ' + error.message, 'err'); if (barWrap) barWrap.style.display = 'none'; return }
  const { data: urlData } = sb.storage.from('article-images').getPublicUrl(fileName)
  uploadedImageUrl = urlData.publicUrl
  const fi = document.getElementById('fImageFinal')
  const fu = document.getElementById('fImageUrl')
  if (fi) fi.value = uploadedImageUrl
  if (fu) fu.value = ''
  setTimeout(() => { if (barWrap) barWrap.style.display = 'none'; if (bar) bar.style.width = '0' }, 600)
  toast('عکس آپلود شد ✓', 'ok')
}
function onImageUrlInput(val) {
  if (!val) return
  uploadedImageUrl = ''
  const fi = document.getElementById('fImageFinal')
  if (fi) fi.value = val
  const p = document.getElementById('uploadPreview')
  if (p) { p.src = val; p.style.display = 'block' }
  const ph = document.getElementById('uploadPlaceholder')
  if (ph) ph.style.display = 'none'
}

// ══════════════════════════════════════════
//  RICH TEXT EDITOR
// ══════════════════════════════════════════
function execCmd(cmd, val = null) {
  document.getElementById('editorBody').focus()
  document.execCommand(cmd, false, val)
  updateWordCount()
}
function insertBlockquote() {
  const t = window.getSelection()?.toString() || 'نقل‌قول را اینجا بنویسید'
  document.execCommand('insertHTML', false, `<blockquote>${t}</blockquote><p><br></p>`)
}
function insertCode() {
  const t = window.getSelection()?.toString() || 'کد'
  document.execCommand('insertHTML', false, `<code>${t}</code>`)
}
function insertCodeBlock() {
  document.execCommand('insertHTML', false, `<pre>// کد اینجا\nconsole.log('Hello')</pre><p><br></p>`)
}
function insertHR() { document.execCommand('insertHTML', false, '<hr><p><br></p>') }
function insertAd() {
  const adCode = '<div id="pos-article-display-card-116213"></div><p><br></p>';
  document.execCommand('insertHTML', false, adCode);
  updateWordCount();
}
function openLinkModal() {
  const sel = window.getSelection()
  if (sel && sel.rangeCount > 0) savedRange = sel.getRangeAt(0).cloneRange()
  document.getElementById('linkText').value = sel?.toString() || ''
  document.getElementById('linkUrl').value = ''
  document.getElementById('linkModal').classList.add('open')
}
function closeModal(id) { document.getElementById(id || 'linkModal').classList.remove('open') }
function insertLink() {
  const text = document.getElementById('linkText').value.trim()
  const url  = document.getElementById('linkUrl').value.trim()
  if (!url) { toast('آدرس لینک را وارد کن', 'err'); return }
  document.getElementById('editorBody').focus()
  if (savedRange) { const s = window.getSelection(); s.removeAllRanges(); s.addRange(savedRange) }
  document.execCommand('insertHTML', false, `<a href="${x(url)}" target="_blank" rel="noopener">${x(text || url)}</a>`)
  closeModal(); savedRange = null
}
function updateWordCount() {
  const el = document.getElementById('wordCount')
  if (!el) return
  const words = (document.getElementById('editorBody')?.innerText || '').trim().split(/\s+/).filter(w => w).length
  el.textContent = words + ' کلمه'
}

// ══════════════════════════════════════════
//  ADMIN PANELS
// ══════════════════════════════════════════
function showAdminPanel(name) {
  document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'))
  const sbEl = document.getElementById('sb-' + name)
  if (sbEl) sbEl.classList.add('active')
  const titles = {
    articles: 'مدیریت مقالات', 'new-article': 'مقاله جدید',
    slider: 'مدیریت اسلایدر', settings: 'تنظیمات سایت', stats: 'آمار سایت'
  }
  document.getElementById('adminTopbarTitle').textContent = titles[name] || ''
  const c = document.getElementById('adminContent')
  if (name === 'articles')    renderArticlesList(c)
  if (name === 'new-article') renderArticleForm(c)
  if (name === 'slider')      renderSliderAdmin(c)
  if (name === 'settings')    renderSettingsAdmin(c)
  if (name === 'stats')       renderStatsAdmin(c)
}

async function renderArticlesList(c) {
  c.innerHTML = spinning(true)
  const { data, error } = await sb.from('articles').select('*').order('created_at', { ascending: false })
  if (error) { c.innerHTML = errHtml(error.message); return }

  const totalCount = data.length
  const cats = [...new Set(data.map(r => r.category).filter(Boolean))]

  const header = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="showAdminPanel('new-article')">✏️ مقاله جدید</button>
        <div class="status-bar">
          <span class="status-dot green"></span>
          <span>${totalCount} مقاله</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div style="position:relative">
          <input id="listSearch" class="f-input" placeholder="🔍 جستجو..." style="padding:8px 14px;font-size:13px;width:200px"
            oninput="filterArticleList(this.value)">
        </div>
        <select id="listCatFilter" class="f-select" style="padding:8px 14px;font-size:13px;width:auto"
          onchange="filterArticleList(document.getElementById('listSearch').value)">
          <option value="">همه دسته‌ها</option>
          ${cats.map(c => `<option value="${x(c)}">${x(c)}</option>`).join('')}
        </select>
      </div>
    </div>`

  if (!data.length) {
    c.innerHTML = header + `<div class="panel"><div style="text-align:center;padding:56px;color:var(--text3)"><div style="font-size:56px;margin-bottom:16px">📂</div><h3 style="color:var(--text2);margin-bottom:8px">هنوز مقاله‌ای ندارید</h3><p>اولین مقاله را بنویسید</p></div></div>`
    return
  }

  const listHtml = data.map(a => {
    const wc = calcWordCount(a.full_content || '')
    const readMin = Math.max(1, Math.ceil(wc / 200))
    const strippedDesc = stripHtml(a.short_description || '').substring(0, 100)
    return `
    <div class="art-list-item" data-title="${x(a.title).toLowerCase()}" data-cat="${x(a.category || '')}">
      <div class="art-list-thumb">${a.image
        ? `<img src="${x(a.image)}" onerror="this.parentElement.textContent='📄'" loading="lazy">`
        : '📄'}</div>
      <div class="art-list-info">
        <div class="art-list-title" title="${x(a.title)}">${x(a.title)}</div>
        <div class="art-list-preview">${x(strippedDesc)}</div>
        <div class="art-list-meta" style="margin-top:6px">
          <span>📅 ${fd(a.created_at)}</span>
          ${a.category ? `<span class="badge">${x(a.category)}</span>` : ''}
          <span class="read-time">⏱ ${readMin} دقیقه</span>
          <span>${wc} کلمه</span>
        </div>
      </div>
      <div class="art-list-actions">
        <button class="btn btn-ghost" style="padding:7px 12px;font-size:12px" title="پیش‌نمایش" onclick="go('detail',${a.id})">👁</button>
        <button class="btn btn-warn" style="font-size:12px" title="ویرایش" onclick="editArticle(${a.id})">✏ ویرایش</button>
        <button class="btn btn-danger" style="font-size:12px" title="حذف" onclick="deleteArticle(${a.id})">🗑</button>
      </div>
    </div>`
  }).join('')

  c.innerHTML = header + `<div class="panel" id="artListPanel">${listHtml}</div>`
  window._allArticleListItems = data
}

function filterArticleList(q) {
  const catVal = document.getElementById('listCatFilter')?.value || ''
  document.querySelectorAll('.art-list-item').forEach(el => {
    const titleMatch = el.dataset.title.includes((q || '').toLowerCase())
    const catMatch = !catVal || el.dataset.cat === catVal
    el.style.display = (titleMatch && catMatch) ? '' : 'none'
  })
}

function calcWordCount(html) {
  return (stripHtml(html || '')).trim().split(/\s+/).filter(w => w).length
}

function renderArticleForm(c, article = null) {
  const isEdit = !!article
  window._editorMode = 'write'
  window._autoSaveTimer = null
  window._articleTags = isEdit ? (article.tags ? (typeof article.tags === 'string' ? article.tags.split(',').filter(Boolean) : article.tags) : []) : []

  c.innerHTML = `
  <div style="display:grid;grid-template-columns:1fr 340px;gap:20px;align-items:start">
    <div>
      <div class="form-section">
        <div class="form-section-header" onclick="toggleSection('sec-main')">
          <h4>📝 اطلاعات اصلی</h4>
          <span class="form-section-toggle open" id="toggle-sec-main">▾</span>
        </div>
        <div class="form-section-body" id="sec-main">
          <div class="f-group" style="margin-bottom:12px">
            <label class="f-label">عنوان مقاله *</label>
            <input class="f-input" id="fTitle" placeholder="عنوان جذاب برای مقاله..."
              value="${isEdit ? x(article.title) : ''}"
              oninput="onTitleInput(this.value)" style="font-size:16px;font-weight:700">
            <div class="slug-preview" id="slugPreview">
              <span class="base">📎 slug: </span>
              <span class="slug" id="slugVal">${isEdit ? slugify(article.title||'') : 'عنوان-مقاله'}</span>
            </div>
          </div>
          <div class="f-group" style="margin-bottom:0">
            <label class="f-label">توضیح کوتاه (Meta Description) *</label>
            <input class="f-input" id="fShort" placeholder="خلاصه‌ای جذاب — ۱۲۰ تا ۱۵۶ کاراکتر توصیه می‌شود"
              value="${isEdit ? x(article.short_description) : ''}"
              oninput="updateSEOScore()">
            <div style="display:flex;justify-content:space-between;margin-top:5px">
              <span style="font-size:11px;color:var(--text3)">برای نمایش در گوگل استفاده می‌شود</span>
              <span id="metaLen" style="font-size:11px;color:var(--text3)">0 کاراکتر</span>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-header" onclick="toggleSection('sec-editor')">
          <h4>✍️ محتوای مقاله *</h4>
          <span class="form-section-toggle open" id="toggle-sec-editor">▾</span>
        </div>
        <div class="form-section-body" id="sec-editor" style="padding:0">
          <div class="editor-pro-wrap" id="editorProWrap">
            <div class="editor-topbar">
              <div class="editor-mode-btns">
                <button class="mode-btn active" id="modeWrite" onclick="setEditorMode('write')">✍️ نوشتن</button>
                <button class="mode-btn" id="modeSplit" onclick="setEditorMode('split')">⬛ دو نما</button>
                <button class="mode-btn" id="modePreview" onclick="setEditorMode('preview')">👁 پیش‌نمایش</button>
              </div>
              <div class="editor-stats-bar">
                <span id="eWords">0 کلمه</span>
                <span id="eReadTime">⏱ 0 دقیقه</span>
                <span id="eChars">0 کاراکتر</span>
                <span id="eTOCCount" class="stat-good"></span>
              </div>
            </div>
            <div class="editor-toolbar-pro" id="editorToolbar">
              <div class="tb-group">
                <select class="tb-select" onchange="execCmd2('formatBlock',this.value);this.value='p'">
                  <option value="p">متن</option>
                  <option value="h1">H1</option>
                  <option value="h2">H2</option>
                  <option value="h3">H3</option>
                </select>
              </div>
              <div class="tb-sep"></div>
              <button class="tb-btn" onclick="execCmd2('bold')" title="بولد"><b>B</b></button>
              <button class="tb-btn" onclick="execCmd2('italic')" title="ایتالیک"><i>I</i></button>
              <button class="tb-btn" onclick="execCmd2('underline')" title="خط زیر"><u>U</u></button>
              <button class="tb-btn" onclick="execCmd2('strikeThrough')" title="خط وسط"><s>S</s></button>
              <div class="tb-sep"></div>
              <button class="tb-btn" onclick="execCmd2('insertUnorderedList')" title="لیست نقطه‌ای">☰</button>
              <button class="tb-btn" onclick="execCmd2('insertOrderedList')" title="لیست شماره‌ای">1.</button>
              <div class="tb-sep"></div>
              <button class="tb-btn" onclick="insertBlock('quote')" title="نقل‌قول">❝</button>
              <button class="tb-btn" onclick="insertBlock('code-inline')" title="کد inline">{ }</button>
              <button class="tb-btn" onclick="insertBlock('code-block')" title="بلاک کد">⌨</button>
              <button class="tb-btn" onclick="insertBlock('hr')" title="خط جدا">—</button>
              <div class="tb-sep"></div>
              <button class="tb-btn" onclick="insertBlock('info')" title="باکس اطلاعات" style="font-size:15px">ℹ</button>
              <button class="tb-btn" onclick="insertBlock('warn')" title="باکس هشدار" style="font-size:15px">⚠</button>
              <button class="tb-btn" onclick="insertBlock('success')" title="باکس موفقیت" style="font-size:15px">✅</button>
              <button class="tb-btn" onclick="insertBlock('table')" title="جدول">⊞</button>
              <div class="tb-sep"></div>
              <button class="tb-btn" onclick="insertBlock('toc')" title="فهرست مطالب خودکار" style="background:rgba(34,197,94,.1);color:var(--accent3)">📑 TOC</button>
              <button class="tb-btn" onclick="insertBlock('ad')" title="جایگاه تبلیغ">📢</button>
              <div class="tb-sep"></div>
              <button class="tb-btn" onclick="openLinkModal()" title="لینک">🔗</button>
              <button class="tb-btn" onclick="execCmd2('unlink')" title="حذف لینک">🚫</button>
              <button class="tb-btn" onclick="openInlineImageModal()" title="تصویر در متن">🖼</button>
              <div class="tb-sep"></div>
              <button class="tb-btn" onclick="execCmd2('justifyRight')">⇥</button>
              <button class="tb-btn" onclick="execCmd2('justifyCenter')">≡</button>
              <button class="tb-btn" onclick="execCmd2('justifyLeft')">⇤</button>
              <div class="tb-sep"></div>
              <button class="tb-btn" onclick="execCmd2('undo')">↩</button>
              <button class="tb-btn" onclick="execCmd2('redo')">↪</button>
              <button class="tb-btn" onclick="clearEditorFormatting()" style="color:var(--red)" title="پاک کردن قالب">✕F</button>
            </div>
            <div style="display:flex;min-height:420px">
              <div class="editor-pane" id="writePanelWrap" style="flex:1">
                <div class="editor-body-pro" id="editorBody" contenteditable="true"
                  data-placeholder="متن مقاله را اینجا بنویسید... (H2 و H3 ها به فهرست خودکار تبدیل می‌شوند)"
                  oninput="onEditorInput()"
                  >${isEdit ? (article.full_content || '') : ''}</div>
              </div>
              <div class="editor-pane preview-pane" id="previewPanelWrap" style="flex:1;display:none">
                <div class="editor-pane-label">پیش‌نمایش</div>
                <div class="preview-inner" id="previewBody"></div>
              </div>
            </div>
            <div class="editor-footer-pro">
              <div class="autosave-indicator">
                <div class="autosave-dot" id="autoSaveDot"></div>
                <span id="autoSaveText">آماده</span>
              </div>
              <div style="display:flex;gap:16px;font-size:11px;color:var(--text3)">
                <span>Ctrl+B بولد</span><span>Ctrl+I ایتالیک</span><span>Ctrl+S ذخیره</span>
              </div>
            </div>
          </div>
          <div class="toc-preview" id="tocPreviewPanel" style="display:none;margin:12px 12px 0">
            <div class="toc-preview-title">
              📑 پیش‌نمایش فهرست مطالب
              <span class="toc-count" id="tocItemCount">0 آیتم</span>
            </div>
            <div id="tocPreviewList"></div>
          </div>
        </div>
      </div>
    </div>

    <div>
      <input type="hidden" id="editId" value="${isEdit ? article.id : ''}">
      <div class="alert alert-err" id="formErr" style="margin-bottom:12px"></div>
      <div class="alert alert-ok" id="formOk" style="margin-bottom:12px"></div>

      <div class="panel" style="padding:16px;margin-bottom:16px">
        <button class="btn btn-primary" id="saveBtn" onclick="saveArticle()"
          style="width:100%;justify-content:center;padding:14px;font-size:15px;font-weight:900">
          💾 ذخیره مقاله
        </button>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-ghost" onclick="showAdminPanel('articles')" style="flex:1;justify-content:center;font-size:12px">انصراف</button>
          ${isEdit ? `<button class="btn btn-ghost" onclick="go('detail',${article.id})" style="flex:1;justify-content:center;font-size:12px">👁 مشاهده</button>` : ''}
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-header" onclick="toggleSection('sec-media')">
          <h4>🖼 تصویر و رسانه</h4>
          <span class="form-section-toggle open" id="toggle-sec-media">▾</span>
        </div>
        <div class="form-section-body" id="sec-media">
          <div class="f-group" style="margin-bottom:10px">
            <div class="upload-area" style="padding:20px">
              <input type="file" id="fImageFile" accept="image/*" onchange="handleImageFile(this)">
              <div id="uploadPlaceholder" ${isEdit && article.image ? 'style="display:none"' : ''}>
                <div style="font-size:24px;margin-bottom:6px">🖼</div>
                <div style="font-size:12px;font-weight:600;color:var(--text2)">تصویر شاخص</div>
                <div style="font-size:11px;color:var(--text3);margin-top:2px">JPG/PNG — حداکثر ۵MB</div>
              </div>
              <img id="uploadPreview" class="upload-preview" ${isEdit && article.image ? `src="${x(article.image)}" style="display:block"` : ''}>
              <div class="upload-bar-wrap" id="uploadBarWrap"><div class="upload-bar" id="uploadBar"></div></div>
            </div>
          </div>
          <div class="f-group" style="margin-bottom:10px">
            <label class="f-label" style="font-size:11px">یا لینک تصویر</label>
            <input class="f-input" id="fImageUrl" type="url" placeholder="https://..." oninput="onImageUrlInput(this.value)"
              value="${isEdit ? x(article.image || '') : ''}" style="font-size:13px">
          </div>
          <input type="hidden" id="fImageFinal" value="${isEdit ? x(article.image || '') : ''}">
          <div class="f-group" style="margin-bottom:0">
            <label class="f-label" style="font-size:11px">لینک ویدیو (یوتیوب/آپارات)</label>
            <input class="f-input" id="fVideo" type="url" placeholder="https://youtube.com/..."
              value="${isEdit ? x(article.video_link || '') : ''}" style="font-size:13px">
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-header" onclick="toggleSection('sec-cat')">
          <h4>🏷 دسته‌بندی و تگ‌ها</h4>
          <span class="form-section-toggle open" id="toggle-sec-cat">▾</span>
        </div>
        <div class="form-section-body" id="sec-cat">
          <div class="f-group" style="margin-bottom:12px">
            <label class="f-label" style="font-size:11px">دسته‌بندی</label>
            <select class="f-select" id="fCat" style="font-size:13px"></select>
            <div class="cat-manager" style="margin-top:8px">
              <div class="cat-manager-title">مدیریت</div>
              <div class="cat-tags" id="catTagsAdmin"></div>
              <div class="cat-add-row">
                <input class="cat-add-input" id="newCatInput" placeholder="دسته جدید..."
                  onkeydown="if(event.key==='Enter'){event.preventDefault();addCategory()}">
                <button class="cat-add-btn" onclick="addCategory()">+</button>
              </div>
            </div>
          </div>
          <div class="f-group" style="margin-bottom:0">
            <label class="f-label" style="font-size:11px">تگ‌ها (Enter یا کاما)</label>
            <div class="tags-input-wrap" id="tagsWrap" onclick="document.getElementById('tagInput').focus()">
              <div id="tagChips"></div>
              <input id="tagInput" class="tags-real-input" placeholder="تگ بزنید..."
                onkeydown="handleTagInput(event)">
            </div>
            <input type="hidden" id="fTags">
          </div>
        </div>
      </div>

      <div class="seo-panel" id="seoPanel">
        <div class="seo-header">
          <div class="seo-title">🔍 امتیاز سئو</div>
          <div class="seo-score-badge bad" id="seoBadge">۰/۱۰۰</div>
        </div>
        <div class="seo-checks" id="seoChecks">
          <div class="seo-check fail"><span class="icon"></span><span>عنوان را وارد کنید</span></div>
        </div>
      </div>

      <div class="toc-preview" id="tocSidePanel" style="margin-top:16px;display:none">
        <div class="toc-preview-title">📑 فهرست مطالب <span class="toc-count" id="tocSideCount">0</span></div>
        <div id="tocSideList"></div>
      </div>
    </div>
  </div>`

  renderCatSelect()
  renderCatAdmin()
  if (isEdit && article.category) {
    const sel = document.getElementById('fCat')
    if (sel) sel.value = article.category
  }
  if (isEdit && article.image) {
    const ph = document.getElementById('uploadPlaceholder')
    if (ph) ph.style.display = 'none'
  }
  renderTags()
  onEditorInput()
  updateSEOScore()
  document.addEventListener('keydown', function _ks(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveArticle() }
  })
  setupAutosave()
}

// ── TOC GENERATOR ──
function buildTOC(container) {
  const headings = (container || document.getElementById('editorBody'))
    ?.querySelectorAll('h2, h3') || []
  return Array.from(headings).map((h, i) => {
    const id = 'heading-' + i
    h.id = id
    return { tag: h.tagName.toLowerCase(), text: h.textContent.trim(), id }
  })
}

function renderTOCPreviews() {
  const toc = buildTOC()
  const count = toc.length
  const inPanel = document.getElementById('tocPreviewPanel')
  const inList  = document.getElementById('tocPreviewList')
  const inCnt   = document.getElementById('tocItemCount')
  const sidePanel = document.getElementById('tocSidePanel')
  const sideList  = document.getElementById('tocSideList')
  const sideCnt   = document.getElementById('tocSideCount')
  const eStat     = document.getElementById('eTOCCount')
  if (count === 0) {
    if (inPanel)   inPanel.style.display = 'none'
    if (sidePanel) sidePanel.style.display = 'none'
    if (eStat) eStat.textContent = ''
    return
  }
  const listHTML = toc.map(item => `
    <div class="toc-preview-item ${item.tag}">
      <span style="color:var(--accent3)">${item.tag === 'h2' ? '■' : '○'}</span>
      <span>${x(item.text)}</span>
    </div>`).join('')
  if (inPanel)   { inPanel.style.display = 'block'; inList.innerHTML = listHTML; inCnt.textContent = count + ' آیتم' }
  if (sidePanel) { sidePanel.style.display = 'block'; sideList.innerHTML = listHTML; sideCnt.textContent = count }
  if (eStat)     { eStat.textContent = '📑 ' + count + ' سرتیتر'; eStat.className = 'stat-good' }
}

function generateTOCHtml() {
  const toc = buildTOC()
  if (!toc.length) { toast('ابتدا H2 یا H3 در متن اضافه کنید', 'err'); return null }
  const items = toc.map(item =>
    `<li class="${item.tag}">
      <a href="#${item.id}">${item.text}</a>
    </li>`
  ).join('')
  return `<nav class="article-toc">
    <div class="toc-toggle-header" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.toc-toggle-arrow').classList.toggle('open')">
      <div class="toc-toggle-title">📑 فهرست مطالب</div>
      <span class="toc-toggle-arrow open">▾</span>
    </div>
    <div class="toc-body open">
      <ol>${items}</ol>
    </div>
  </nav><p><br></p>`
}

// ── EDITOR HELPERS ──
function execCmd2(cmd, val = null) {
  document.getElementById('editorBody').focus()
  document.execCommand(cmd, false, val)
  onEditorInput()
}

function insertBlock(type) {
  const body = document.getElementById('editorBody')
  body.focus()
  let html = ''
  switch(type) {
    case 'quote':       html = `<blockquote>نقل‌قول را اینجا بنویسید...</blockquote><p><br></p>`; break
    case 'code-inline': html = `<code>کد</code>`; break
    case 'code-block':  html = `<pre>// کد خود را اینجا بنویسید\nconsole.log('Hello')</pre><p><br></p>`; break
    case 'hr':          html = `<hr><p><br></p>`; break
    case 'info':    html = `<div class="info-box">ℹ️ اطلاعیه: متن خود را اینجا بنویسید...</div><p><br></p>`; break
    case 'warn':    html = `<div class="warn-box">⚠️ هشدار: متن خود را اینجا بنویسید...</div><p><br></p>`; break
    case 'success': html = `<div class="success-box">✅ نکته: متن خود را اینجا بنویسید...</div><p><br></p>`; break
    case 'table':
      html = `<table><tr><th>ستون ۱</th><th>ستون ۲</th><th>ستون ۳</th></tr>
        <tr><td>ردیف ۱</td><td>مقدار</td><td>مقدار</td></tr>
        <tr><td>ردیف ۲</td><td>مقدار</td><td>مقدار</td></tr></table><p><br></p>`; break
    case 'toc': { const tocHtml = generateTOCHtml(); if (!tocHtml) return; html = tocHtml; break }
    case 'ad': html = `<div id="pos-article-display-card-116213"></div><p><br></p>`; break
  }
  document.execCommand('insertHTML', false, html)
  onEditorInput()
}

function clearEditorFormatting() {
  document.execCommand('removeFormat')
  document.execCommand('unlink')
  onEditorInput()
}

function openInlineImageModal() {
  const url = prompt('آدرس تصویر را وارد کنید:')
  if (!url) return
  const caption = prompt('کپشن تصویر (اختیاری):') || ''
  const html = `<figure class="img-with-caption">
    <img src="${url}" alt="${caption}" style="max-width:100%;border-radius:8px;border:1px solid rgba(255,255,255,.1)">
    ${caption ? `<figcaption>${caption}</figcaption>` : ''}
  </figure><p><br></p>`
  document.getElementById('editorBody').focus()
  document.execCommand('insertHTML', false, html)
  onEditorInput()
}

function setEditorMode(mode) {
  window._editorMode = mode
  const wrap = document.getElementById('editorProWrap')
  const writePanel = document.getElementById('writePanelWrap')
  const previewPanel = document.getElementById('previewPanelWrap')
  const toolbar = document.getElementById('editorToolbar')
  document.getElementById('modeWrite').classList.toggle('active', mode === 'write')
  document.getElementById('modeSplit').classList.toggle('active', mode === 'split')
  document.getElementById('modePreview').classList.toggle('active', mode === 'preview')
  if (mode === 'write') {
    wrap.classList.remove('split-view')
    writePanel.style.display = 'flex'; writePanel.style.flex = '1'
    previewPanel.style.display = 'none'
    toolbar.style.display = 'flex'
  } else if (mode === 'split') {
    wrap.classList.add('split-view')
    writePanel.style.display = 'flex'; writePanel.style.flex = '1'
    previewPanel.style.display = 'block'; previewPanel.style.flex = '1'
    toolbar.style.display = 'flex'
    updatePreview()
  } else {
    wrap.classList.remove('split-view')
    writePanel.style.display = 'none'
    previewPanel.style.display = 'block'; previewPanel.style.flex = '1'
    toolbar.style.display = 'none'
    updatePreview()
  }
}

function updatePreview() {
  const body = document.getElementById('editorBody')
  const prev = document.getElementById('previewBody')
  if (!prev || !body) return
  prev.innerHTML = body.innerHTML
}

function onEditorInput() {
  const body = document.getElementById('editorBody')
  if (!body) return
  const text = body.innerText || ''
  const words = text.trim().split(/\s+/).filter(w => w).length
  const chars = text.length
  const readMin = Math.max(1, Math.ceil(words / 200))
  const eW = document.getElementById('eWords')
  const eR = document.getElementById('eReadTime')
  const eC = document.getElementById('eChars')
  if (eW) eW.textContent = words + ' کلمه'
  if (eR) { eR.textContent = '⏱ ' + readMin + ' دقیقه'; eR.className = words > 300 ? 'stat-good' : 'stat-warn' }
  if (eC) eC.textContent = chars + ' کاراکتر'
  renderTOCPreviews()
  if (window._editorMode === 'split') updatePreview()
  updateSEOScore()
  triggerAutosave()
}

function updateSEOScore() {
  const title = document.getElementById('fTitle')?.value || ''
  const desc  = document.getElementById('fShort')?.value || ''
  const body  = document.getElementById('editorBody')?.innerText || ''
  const image = document.getElementById('fImageFinal')?.value || document.getElementById('fImageUrl')?.value || ''
  const metaLenEl = document.getElementById('metaLen')
  if (metaLenEl) {
    metaLenEl.textContent = desc.length + ' کاراکتر'
    metaLenEl.style.color = (desc.length >= 120 && desc.length <= 156) ? 'var(--accent3)' : desc.length > 156 ? 'var(--red)' : 'var(--text3)'
  }
  const checks = [
    { label: 'عنوان وجود دارد', pass: title.length > 0 },
    { label: 'عنوان ۳۰–۶۰ کاراکتر', pass: title.length >= 30 && title.length <= 60, warn: title.length > 0 && title.length < 20 },
    { label: 'توضیح متا وجود دارد', pass: desc.length > 0 },
    { label: 'توضیح ۱۲۰–۱۵۶ کاراکتر', pass: desc.length >= 120 && desc.length <= 156, warn: desc.length > 0 && desc.length < 100 },
    { label: 'تصویر شاخص دارد', pass: !!image },
    { label: 'محتوا بیش از ۳۰۰ کلمه', pass: body.trim().split(/\s+/).filter(w=>w).length >= 300 },
    { label: 'محتوا بیش از ۶۰۰ کلمه', pass: body.trim().split(/\s+/).filter(w=>w).length >= 600 },
    { label: 'H2 یا H3 در متن دارد', pass: !!document.getElementById('editorBody')?.querySelector('h2,h3') },
    { label: 'لینک در متن وجود دارد', pass: !!document.getElementById('editorBody')?.querySelector('a') },
    { label: 'تصویر در متن دارد', pass: !!document.getElementById('editorBody')?.querySelector('img') },
  ]
  const passed = checks.filter(c => c.pass).length
  const score = Math.round((passed / checks.length) * 100)
  const badge = document.getElementById('seoBadge')
  const checksEl = document.getElementById('seoChecks')
  if (badge) {
    badge.textContent = score + '/۱۰۰'
    badge.className = 'seo-score-badge ' + (score >= 70 ? 'good' : score >= 40 ? 'ok' : 'bad')
  }
  if (checksEl) {
    checksEl.innerHTML = checks.map(c => {
      const cls = c.pass ? 'pass' : (c.warn ? 'warn' : 'fail')
      return `<div class="seo-check ${cls}"><span class="icon"></span><span>${c.label}</span></div>`
    }).join('')
  }
}

function setupAutosave() {
  const editId = document.getElementById('editId')?.value
  const draftKey = 'draft_' + (editId || 'new')
  if (!editId) {
    try {
      const draft = localStorage.getItem(draftKey)
      if (draft) {
        const d = JSON.parse(draft)
        if (d.content && confirm('پیش‌نویس ذخیره‌شده پیدا شد. بارگذاری شود؟')) {
          document.getElementById('editorBody').innerHTML = d.content
          if (d.title) document.getElementById('fTitle').value = d.title
          if (d.short) document.getElementById('fShort').value = d.short
          onEditorInput()
          toast('پیش‌نویس بارگذاری شد ✓', 'ok')
        }
      }
    } catch(e) {}
  }
}

function triggerAutosave() {
  clearTimeout(window._autoSaveTimer)
  const dot = document.getElementById('autoSaveDot')
  const txt = document.getElementById('autoSaveText')
  if (dot) dot.className = 'autosave-dot saving'
  if (txt) txt.textContent = 'در حال ذخیره...'
  window._autoSaveTimer = setTimeout(() => {
    const editId = document.getElementById('editId')?.value
    const draftKey = 'draft_' + (editId || 'new')
    try {
      localStorage.setItem(draftKey, JSON.stringify({
        content: document.getElementById('editorBody')?.innerHTML || '',
        title: document.getElementById('fTitle')?.value || '',
        short: document.getElementById('fShort')?.value || '',
        ts: Date.now()
      }))
    } catch(e) {}
    if (dot) { dot.className = 'autosave-dot saved'; setTimeout(() => { if(dot) dot.className='autosave-dot' }, 2500) }
    if (txt) { txt.textContent = 'ذخیره خودکار ✓'; setTimeout(() => { if(txt) txt.textContent='آماده' }, 2500) }
  }, 1500)
}

function slugify(str) {
  return (str||'').trim().replace(/\s+/g, '-').replace(/[^\u0600-\u06FFa-zA-Z0-9\-]/g, '').substring(0, 60)
}

function onTitleInput(val) {
  const sl = document.getElementById('slugVal')
  if (sl) sl.textContent = slugify(val) || 'عنوان-مقاله'
  updateSEOScore()
}

function renderTags() {
  const chips = document.getElementById('tagChips')
  if (!chips) return
  chips.innerHTML = (window._articleTags || []).map(tag =>
    `<span class="tag-chip">${x(tag)}<span class="del" onclick="removeTag('${x(tag)}')">×</span></span>`
  ).join('')
  const fi = document.getElementById('fTags')
  if (fi) fi.value = (window._articleTags || []).join(',')
}

function handleTagInput(e) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault()
    const val = e.target.value.trim().replace(/,/g,'')
    if (!val) return
    if (!window._articleTags) window._articleTags = []
    if (!window._articleTags.includes(val)) { window._articleTags.push(val); renderTags() }
    e.target.value = ''
  } else if (e.key === 'Backspace' && !e.target.value && window._articleTags?.length) {
    window._articleTags.pop(); renderTags()
  }
}

function removeTag(tag) { window._articleTags = (window._articleTags || []).filter(t => t !== tag); renderTags() }

function toggleSection(id) {
  const body = document.getElementById(id)
  const toggle = document.getElementById('toggle-' + id)
  if (!body) return
  const isOpen = body.style.display !== 'none'
  body.style.display = isOpen ? 'none' : ''
  if (toggle) toggle.classList.toggle('open', !isOpen)
}


async function editArticle(id) {
  const { data: a } = await sb.from('articles').select('*').eq('id', id).single()
  if (!a) return
  showAdminPanel('new-article')
  const c = document.getElementById('adminContent')
  renderArticleForm(c, a)
}

async function saveArticle() {
  const title   = document.getElementById('fTitle')?.value.trim()
  const image   = document.getElementById('fImageFinal')?.value.trim() || document.getElementById('fImageUrl')?.value.trim()
  const video   = document.getElementById('fVideo')?.value.trim()
  const short   = document.getElementById('fShort')?.value.trim()
  const content = document.getElementById('editorBody')?.innerHTML.trim()
  const cat     = document.getElementById('fCat')?.value
  const tags    = document.getElementById('fTags')?.value || ''
  const editId  = document.getElementById('editId')?.value
  const errEl   = document.getElementById('formErr')
  const okEl    = document.getElementById('formOk')
  const btn     = document.getElementById('saveBtn')
  hide(errEl); hide(okEl)
  if (!title)   { showAlert(errEl, '⚠️ عنوان مقاله را وارد کنید'); return }
  if (!short)   { showAlert(errEl, '⚠️ توضیح کوتاه را وارد کنید'); return }
  if (!content || content === '<br>') { showAlert(errEl, '⚠️ متن مقاله را وارد کنید'); return }
  btn.innerHTML = '<span class="spin"></span> ذخیره...'; btn.disabled = true
  const payload = { title, image, video_link: video, short_description: short, full_content: content, category: cat }
  const { error } = editId
    ? await sb.from('articles').update(payload).eq('id', editId)
    : await sb.from('articles').insert([payload])
  btn.innerHTML = '💾 ذخیره مقاله'; btn.disabled = false
  if (error) {
    let msg = 'خطا: ' + error.message
    if (error.message.includes('policy')) msg = '⚠️ دسترسی رد شد — لاگین هستی؟'
    showAlert(errEl, msg); return
  }
  // Clear draft
  const draftKey = 'draft_' + (editId || 'new')
  try { localStorage.removeItem(draftKey) } catch(e) {}
  showAlert(okEl, editId ? '✅ مقاله ویرایش شد' : '✅ مقاله اضافه شد')
  toast(editId ? 'مقاله ویرایش شد ✓' : 'مقاله اضافه شد ✓', 'ok')
  setTimeout(() => showAdminPanel('articles'), 1000)
}

async function deleteArticle(id) {
  if (!confirm('این مقاله حذف شود؟')) return
  const { error } = await sb.from('articles').delete().eq('id', id)
  if (error) { toast('خطا: ' + error.message, 'err'); return }
  toast('مقاله حذف شد', 'ok')
  showAdminPanel('articles')
}

// ── SLIDER ADMIN ──
function renderSliderAdmin(c) {
  const slides = getSlides()
  c.innerHTML = `
    <div class="panel">
      <div class="panel-title">🎠 اسلایدهای فعلی</div>
      <div id="slidesList">${renderSlidesList(slides)}</div>
      <button class="btn btn-primary" style="margin-top:18px" onclick="openAddSlide()">+ اسلاید جدید</button>
    </div>
    <div class="panel" id="slideFormPanel" style="display:none">
      <div class="panel-title" id="slideFormTitle">اسلاید جدید</div>
      <div class="f-grid">
        <div class="f-group f-full"><label class="f-label">عنوان اسلاید *</label><input class="f-input" id="sTitle" placeholder="عنوان اسلاید"></div>
        <div class="f-group f-full"><label class="f-label">توضیح</label><input class="f-input" id="sDesc" placeholder="توضیح کوتاه"></div>
        <div class="f-group"><label class="f-label">لینک تصویر پس‌زمینه</label><input class="f-input" id="sImage" placeholder="https://..."></div>
        <div class="f-group"><label class="f-label">نشان (Badge)</label><input class="f-input" id="sBadge" placeholder="مثلاً: جدید، ویژه"></div>
        <div class="f-group"><label class="f-label">متن دکمه</label><input class="f-input" id="sBtn" placeholder="مثلاً: مشاهده مقاله"></div>
        <div class="f-group"><label class="f-label">ID مقاله (لینک دکمه)</label><input class="f-input" id="sLink" type="number" placeholder="ID مقاله"></div>
      </div>
      <input type="hidden" id="sEditIdx" value="-1">
      <div style="display:flex;gap:10px;margin-top:18px">
        <button class="btn btn-primary" onclick="saveSlide()">💾 ذخیره اسلاید</button>
        <button class="btn btn-ghost" onclick="document.getElementById('slideFormPanel').style.display='none'">انصراف</button>
      </div>
    </div>`
}

function renderSlidesList(slides) {
  if (!slides.length) return `<div style="text-align:center;padding:32px;color:var(--text3)"><div style="font-size:40px;margin-bottom:10px">🎠</div><p>هنوز اسلایدی ندارید</p></div>`
  return slides.map((s, i) => `
    <div class="slide-admin-card">
      <div class="slide-admin-thumb">${s.image ? `<img src="${x(s.image)}" onerror="this.parentElement.textContent='🖼'">` : '🖼'}</div>
      <div class="slide-admin-info">
        <div class="slide-admin-title">${x(s.title)}</div>
        <div style="font-size:11px;color:var(--text3)">${s.desc ? x(s.desc).substring(0,50)+'...' : 'بدون توضیح'}</div>
      </div>
      <div class="slide-admin-actions">
        <button class="btn btn-warn" style="font-size:12px" onclick="editSlide(${i})">✏</button>
        <button class="btn btn-danger" style="font-size:12px" onclick="deleteSlide(${i})">🗑</button>
      </div>
    </div>`).join('')
}

function openAddSlide() {
  ['sTitle','sDesc','sImage','sBadge','sBtn','sLink'].forEach(id => { const el = document.getElementById(id); if(el) el.value = '' })
  document.getElementById('sEditIdx').value = -1
  document.getElementById('slideFormTitle').textContent = 'اسلاید جدید'
  document.getElementById('slideFormPanel').style.display = 'block'
  document.getElementById('slideFormPanel').scrollIntoView({ behavior: 'smooth' })
}

function editSlide(i) {
  const s = getSlides()[i]
  if (!s) return
  document.getElementById('sTitle').value = s.title || ''
  document.getElementById('sDesc').value  = s.desc  || ''
  document.getElementById('sImage').value = s.image || ''
  document.getElementById('sBadge').value = s.badge || ''
  document.getElementById('sBtn').value   = s.btn   || ''
  document.getElementById('sLink').value  = s.link  || ''
  document.getElementById('sEditIdx').value = i
  document.getElementById('slideFormTitle').textContent = 'ویرایش اسلاید'
  document.getElementById('slideFormPanel').style.display = 'block'
  document.getElementById('slideFormPanel').scrollIntoView({ behavior: 'smooth' })
}

function saveSlide() {
  const title = document.getElementById('sTitle').value.trim()
  if (!title) { toast('عنوان اسلاید الزامی است', 'err'); return }
  const slide = {
    title,
    desc:  document.getElementById('sDesc').value.trim(),
    image: document.getElementById('sImage').value.trim(),
    badge: document.getElementById('sBadge').value.trim(),
    btn:   document.getElementById('sBtn').value.trim(),
    link:  document.getElementById('sLink').value.trim()
  }
  const slides = getSlides()
  const idx = parseInt(document.getElementById('sEditIdx').value)
  if (idx >= 0) slides[idx] = slide
  else slides.push(slide)
  saveSlides(slides)
  document.getElementById('slidesList').innerHTML = renderSlidesList(slides)
  document.getElementById('slideFormPanel').style.display = 'none'
  toast('اسلاید ذخیره شد ✓', 'ok')
}

function deleteSlide(i) {
  if (!confirm('این اسلاید حذف شود؟')) return
  const slides = getSlides()
  slides.splice(i, 1)
  saveSlides(slides)
  document.getElementById('slidesList').innerHTML = renderSlidesList(slides)
  toast('اسلاید حذف شد', 'ok')
}

// ── SETTINGS ADMIN ──
function renderSettingsAdmin(c) {
  const s = getSiteSettings()
  c.innerHTML = `
    <div class="panel">
      <div class="panel-title">⚙️ تنظیمات کلی سایت</div>
      <div class="settings-grid">
        <div class="f-group"><label class="f-label">نام سایت</label><input class="f-input" id="setName" value="${x(s.siteName)}" placeholder="نام سایت"></div>
        <div class="f-group"><label class="f-label">توضیح کوتاه سایت</label><input class="f-input" id="setDesc" value="${x(s.siteDesc)}" placeholder="توضیح زیر لوگو"></div>
        <div class="f-group">
          <label class="f-label">رنگ اصلی سایت</label>
          <div class="color-input-wrap">
            <input type="color" id="setColorPicker" value="${s.accentColor}" oninput="document.getElementById('setColor').value=this.value">
            <input class="f-input" id="setColor" value="${s.accentColor}" placeholder="#22c55e" oninput="document.getElementById('setColorPicker').value=this.value">
          </div>
        </div>
        <div class="f-group"><label class="f-label">متن فوتر</label><input class="f-input" id="setFooter" value="${x(s.footerText)}" placeholder="متن پایین سایت"></div>
      </div>
      <div style="margin-top:22px;display:flex;gap:10px">
        <button class="btn btn-primary" onclick="saveSiteSettingsAdmin()">💾 ذخیره تنظیمات</button>
        <button class="btn btn-ghost" onclick="resetSettingsAdmin()">↩ بازگشت به پیش‌فرض</button>
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">🗑 مدیریت داده‌ها</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:18px">پاک کردن تنظیمات محلی (اسلایدر، دسته‌بندی‌ها، تنظیمات) — داده‌های Supabase تغییر نمی‌کنند.</p>
      <button class="btn btn-danger" onclick="clearLocalData()">🗑 پاک کردن تنظیمات محلی</button>
    </div>`
}

function saveSiteSettingsAdmin() {
  const s = {
    siteName:    document.getElementById('setName').value.trim()   || 'درآمد نو',
    siteDesc:    document.getElementById('setDesc').value.trim()   || '',
    accentColor: document.getElementById('setColor').value.trim()  || '#22c55e',
    footerText:  document.getElementById('setFooter').value.trim() || ''
  }
  saveSiteSettings(s); applySiteSettings()
  toast('تنظیمات ذخیره شد ✓', 'ok')
}

function resetSettingsAdmin() {
  localStorage.removeItem(SETTINGS_KEY); applySiteSettings()
  renderSettingsAdmin(document.getElementById('adminContent'))
  toast('تنظیمات به پیش‌فرض برگشت', 'ok')
}

function clearLocalData() {
  if (!confirm('تمام تنظیمات محلی پاک شود؟')) return
  ;[SETTINGS_KEY, CAT_KEY, SLIDE_KEY].forEach(k => localStorage.removeItem(k))
  applySiteSettings(); toast('داده‌های محلی پاک شد', 'ok')
}

// ── STATS ADMIN ──
async function renderStatsAdmin(c) {
  c.innerHTML = spinning(true)
  const { count } = await sb.from('articles').select('*', { count: 'exact', head: true })
  const { data: cats } = await sb.from('articles').select('category').not('category', 'is', null)
  const catCount = new Set((cats || []).map(r => r.category).filter(Boolean)).size
  c.innerHTML = `
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-num">${count || 0}</div><div class="stat-label">📄 کل مقالات</div></div>
      <div class="stat-card"><div class="stat-num">${catCount}</div><div class="stat-label">🏷 دسته‌بندی‌ها</div></div>
      <div class="stat-card"><div class="stat-num">${getSlides().length}</div><div class="stat-label">🎠 اسلایدها</div></div>
    </div>
    <div class="panel">
      <div class="panel-title">📋 آخرین مقالات</div>
      <div id="statsList"></div>
    </div>`
  const { data } = await sb.from('articles').select('id,title,created_at,category').order('created_at', { ascending: false }).limit(5)
  document.getElementById('statsList').innerHTML = (data || []).map(a => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border);font-size:13px">
      <span style="font-weight:700;color:var(--text)">${x(a.title)}</span>
      <span style="color:var(--text3)">${fd(a.created_at)}</span>
    </div>`).join('')
}

// ══════════════════════════════════════════
//  SEO
// ══════════════════════════════════════════
function updateSEO({ title, description, image, url, type = 'article' }) {
  document.getElementById('metaTitle').textContent = title
  document.getElementById('metaDesc').setAttribute('content', description)
  document.getElementById('metaCanonical').setAttribute('href', url || BASE_URL)
  document.getElementById('ogTitle').setAttribute('content', title)
  document.getElementById('ogDesc').setAttribute('content', description)
  document.getElementById('ogImage').setAttribute('content', image || '')
  document.getElementById('ogType').setAttribute('content', type)
}
function resetSEO() {
  const s = getSiteSettings()
  updateSEO({ title: s.siteName + ' | مقالات کسب درآمد', description: s.siteDesc, type: 'website' })
}
function setArticleSEO(a) {
  updateSEO({
    title: a.title + ' | ' + getSiteSettings().siteName,
    description: a.short_description,
    image: a.image,
    url: BASE_URL + '?article=' + a.id
  })
  document.getElementById('schemaOrg').textContent = JSON.stringify({
    "@context":"https://schema.org","@type":"Article",
    "headline":a.title,"description":a.short_description,
    "image":a.image||"","datePublished":a.created_at,
    "author":{"@type":"Organization","name":getSiteSettings().siteName},
    "inLanguage":"fa"
  })
}

// ══════════════════════════════════════════
//  DEEP LINK
// ══════════════════════════════════════════
function checkDeepLink() {
  const id = new URLSearchParams(location.search).get('article')
  if (id && sbReady) { go('detail', id); return true }
  return false
}

// ══════════════════════════════════════════
//  HELPERS
// ══════════════════════════════════════════
function x(s='') { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') }
function stripHtml(s='') { return s.replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim() }
function fd(iso) { try { return new Date(iso).toLocaleDateString('fa-IR') } catch { return '' } }
function ytEmbed(url) {
  if (!url) return null
  if (url.includes('youtube.com/embed/')) return url
  const m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/)
  return m ? 'https://www.youtube.com/embed/' + m[1] : null
}
function showAlert(el, msg) { if(el){el.textContent = msg; el.style.display = 'block'} }
function hide(el) { if (el) el.style.display = 'none' }
function toast(msg, type = '') {
  const el = document.getElementById('toast')
  el.textContent = msg; el.className = 'toast ' + type + ' show'
  clearTimeout(el._t); el._t = setTimeout(() => el.classList.remove('show'), 3200)
}
function spinning(full = false) {
  return `<div style="text-align:center;padding:${full?'80':'40'}px 20px;color:var(--text3);grid-column:1/-1">
    <div style="font-size:32px;margin-bottom:12px">⏳</div><p style="font-size:14px">در حال بارگذاری...</p></div>`
}
function errHtml(msg) {
  return `<div class="empty"><div class="empty-icon">⚠️</div><h3>خطا در اتصال</h3><p style="font-size:12px;color:var(--red);margin-top:8px">${x(msg)}</p></div>`
}

// ══════════════════════════════════════════
//  SCROLL HEADER SHADOW
// ══════════════════════════════════════════
window.addEventListener('scroll', () => {
  document.getElementById('hdr').classList.toggle('scrolled', window.scrollY > 10)
  const btt = document.getElementById('backToTop')
  if (btt) btt.classList.toggle('show', window.scrollY > 400)
}, { passive: true })

// ══════════════════════════════════════════
//  START
// ══════════════════════════════════════════
applySiteSettings()
loadTheme()
if (!checkDeepLink()) loadArticles()
loadSlider()
</script>
</body>
</html>
